<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETL Data Validation Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .navigation-tabs {
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
            padding: 0;
            display: flex;
            justify-content: center;
            position: relative;
            overflow-x: auto;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 16px 25px;
            font-size: 1rem;
            font-weight: 600;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 160px;
            justify-content: center;
            flex-shrink: 0;
        }

        .tab-button:hover {
            color: #2c3e50;
            background: rgba(52, 152, 219, 0.1);
            transform: translateY(-2px);
        }

        .tab-button.active {
            color: #2c3e50;
            border-bottom-color: #3498db;
            background: white;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .tab-icon {
            font-size: 1.2rem;
        }

        .tab-label {
            font-weight: 700;
        }

        .page-content {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }

        .page-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page-header {
            background: linear-gradient(135deg, #34495e 0%, #2980b9 100%);
            color: white;
            padding: 25px 30px;
            margin: 0;
        }

        .page-header h2 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-header p {
            opacity: 0.9;
            font-size: 1rem;
            line-height: 1.5;
        }

        .upload-section, .api-configuration-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .upload-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }

        .file-upload-area, .api-config-area {
            border: 3px dashed #3498db;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover, .api-config-area:hover {
            border-color: #2980b9;
            background: #f0f8ff;
            transform: translateY(-2px);
        }

        .file-upload-area.dragover {
            border-color: #27ae60;
            background: #f0fff4;
        }

        .upload-icon {
            font-size: 3rem;
            color: #3498db;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .upload-subtext {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .comparison-options {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .api-config-form {
            text-align: left;
            margin-top: 20px;
        }

        .option-group {
            margin-bottom: 20px;
        }

        .option-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .option-group input, .option-group textarea, .option-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
        }

        .option-group input:focus, .option-group textarea:focus, .option-group select:focus {
            border-color: #3498db;
            outline: none;
        }

        .option-group textarea {
            height: 80px;
            resize: vertical;
            font-family: monospace;
        }

        .field-notice {
            display: block;
            margin-top: 5px;
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
            padding: 5px 10px;
            border-radius: 4px;
            background: #f8f9fa;
        }

        .field-notice.info {
            color: #2563eb;
            background: #eff6ff;
            border-left: 3px solid #2563eb;
        }

        .field-notice.warning {
            color: #dc2626;
            background: #fef2f2;
            border-left: 3px solid #dc2626;
        }

        .field-notice.success {
            color: #16a34a;
            background: #f0fdf4;
            border-left: 3px solid #16a34a;
        }

        .file-preview, .api-preview {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .preview-header {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #3498db;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .clickable-field {
            background: #e3f2fd;
            color: #1565c0;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid #bbdefb;
        }

        .clickable-field:hover {
            background: #1565c0;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .field-category-header {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            margin-top: 15px;
        }

        .field-category-header.first {
            margin-top: 0;
        }

        .processing-state {
            text-align: center;
            padding: 60px 30px;
        }

        .processing-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-text {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .processing-subtext {
            color: #6c757d;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn-primary:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 12px rgba(149, 165, 166, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(149, 165, 166, 0.4);
        }

        .advanced-config {
            border-top: 1px solid #e9ecef;
            padding-top: 20px;
            margin-top: 20px;
        }

        .pagination-config {
            margin-top: 15px;
        }

        .api-actions {
            margin-top: 20px;
            text-align: center;
        }

        .api-source-info {
            margin-top: 15px;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        textarea {
            height: 80px;
            resize: vertical;
            font-family: monospace;
        }

        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .info-box {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid #17a2b8;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .dashboard {
            display: none;
            padding: 30px;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-card.pass {
            border-left-color: #27ae60;
        }

        .metric-card.fail {
            border-left-color: #e74c3c;
        }

        .metric-card.warning {
            border-left-color: #f39c12;
        }

        .metric-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .metric-number.pass {
            color: #27ae60;
        }

        .metric-number.fail {
            color: #e74c3c;
        }

        .metric-number.warning {
            color: #f39c12;
        }

        .metric-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }

        .results-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-header {
            background: #34495e;
            color: white;
            padding: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pass {
            background: #d4edda;
            color: #155724;
        }

        .status-fail {
            background: #f8d7da;
            color: #721c24;
        }

        .error-container {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-left: 5px solid #e53e3e;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.1);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .error-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .error-icon {
            font-size: 2rem;
            margin-right: 15px;
            color: #e53e3e;
            flex-shrink: 0;
        }

        .error-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #742a2a;
            margin: 0 0 8px 0;
        }

        .error-message {
            color: #744210;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .error-suggestions {
            background: #f0fff4;
            border: 1px solid #c6f6d5;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
        }

        .error-suggestions h4 {
            color: #2d3748;
            font-size: 1rem;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .error-suggestions ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .error-suggestions li {
            padding: 6px 0;
            color: #2d3748;
            position: relative;
            padding-left: 25px;
            line-height: 1.5;
        }

        .error-suggestions li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            top: 6px;
            color: #38a169;
            font-weight: bold;
        }

        .result-tab {
            transition: all 0.3s ease;
        }

        .result-tab:hover {
            background: #f0f8ff !important;
            color: #2c3e50 !important;
        }

        .result-tab.active {
            background: white !important;
            border-bottom-color: #3498db !important;
            color: #2c3e50 !important;
        }

        @media (max-width: 768px) {
            .navigation-tabs {
                flex-direction: column;
            }

            .tab-button {
                min-width: auto;
                padding: 15px 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .charts-section {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .upload-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ETL Data Validation Dashboard</h1>
            <p>Advanced data quality monitoring between source (Json/API/RDBMS) Vs Target (BQ)</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="navigation-tabs">
            <button class="tab-button active" onclick="showPage('table-validation')">
                <span class="tab-icon">üî¨</span>
                <span class="tab-label">Sanity Test</span>
            </button>
            <button class="tab-button" onclick="showPage('json-comparison')">
                <span class="tab-icon">üÜö</span>
                <span class="tab-label">JSON vs BQ</span>
            </button>
            <button class="tab-button" onclick="showPage('api-comparison')">
                <span class="tab-icon">üîó</span>
                <span class="tab-label">API vs BQ</span>
            </button>
            <button class="tab-button" onclick="showPage('rdbms-comparison')">
                <span class="tab-icon">üóÑÔ∏è</span>
                <span class="tab-label">RDBMS vs BQ</span>
            </button>
        </div>

        <!-- Page 1: Sanity Test -->
        <div id="table-validation-page" class="page-content active">
            <div class="page-header">
                <h2><span class="tab-icon">üî¨</span> BigQuery Sanity Test</h2>
                <p>Comprehensive data quality checks for your BigQuery tables including null values, duplicates, and special characters</p>
            </div>

            <div class="controls">
                <div class="info-box">
                    <strong>Instructions:</strong> Enter your BigQuery table name and specify columns for sanity checks. The system will run null checks, duplicate detection, composite key duplicates, and special character validation.
                </div>

                <form id="validationForm">
                    <div class="form-group">
                        <label for="tableName">BigQuery Table Name (project.dataset.table)</label>
                        <input type="text" id="tableName" placeholder="e.g., my-project.my_dataset.customer_table" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="nullColumns">Null Check Columns (comma-separated)</label>
                            <textarea id="nullColumns" placeholder="e.g., customer_id, email, first_name"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="duplicateColumns">Duplicate Key Columns (comma-separated)</label>
                            <textarea id="duplicateColumns" placeholder="e.g., customer_id, email"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="compositeKeyColumns">Composite Key Duplicate Check (comma-separated)</label>
                        <textarea id="compositeKeyColumns" placeholder="e.g., first_name, last_name, email"></textarea>
                        <small class="field-notice info">Check for duplicates across multiple columns combined</small>
                    </div>

                    <div class="form-group">
                        <label for="specialCharColumns">Special Character Check Columns (comma-separated)</label>
                        <textarea id="specialCharColumns" placeholder="e.g., first_name, last_name, address"></textarea>
                        <small class="field-notice warning">Provide only STRING columns for special characters check</small>
                    </div>

                    <button type="submit" class="btn" id="runValidation">üöÄ Run Sanity Test</button>
                </form>
            </div>

            <div class="loading" id="loadingSection">
                <div class="spinner"></div>
                <p>Running sanity checks on your BigQuery data...</p>
            </div>

            <div class="dashboard" id="dashboardSection">
                <div class="metrics" id="metricsContainer"></div>

                <div class="charts-section">
                    <div class="chart-container">
                        <div class="chart-title">Sanity Test Results Overview</div>
                        <canvas id="statusChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Issues by Test Type</div>
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>

                <div class="results-table">
                    <div class="table-header">üìä Detailed Sanity Test Results</div>
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th>S.No</th>
                                <th>Test Type</th>
                                <th>Column</th>
                                <th>Count</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Page 2: JSON vs BigQuery Comparison -->
        <div id="json-comparison-page" class="page-content">
            <div class="page-header">
                <h2><span class="tab-icon">üÜö</span> JSON vs BigQuery Comparison</h2>
                <p>Flexible data pipeline validation using any common field - compare JSON files against BigQuery tables with comprehensive analysis</p>
            </div>

            <div class="upload-section" id="upload-section">
                <div class="upload-container">
                    <div class="file-upload-area" id="file-upload-area" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">üìÑ</div>
                        <div class="upload-text">Drop JSON/JSONL files here</div>
                        <div class="upload-subtext">or click to browse ‚Ä¢ Max 100MB ‚Ä¢ .json, .jsonl</div>
                        <input type="file" id="fileInput" accept=".json,.jsonl" style="display: none;">
                    </div>

                    <div class="comparison-options">
                        <h3 style="margin-bottom: 20px; color: #2c3e50;">Configuration</h3>

                        <div class="option-group">
                            <label>BigQuery Table</label>
                            <input type="text" id="bqTable" value="" placeholder="Enter your BigQuery table">
                            <small class="field-notice info">Enter the BigQuery table you want to compare your JSON data against</small>
                        </div>

                        <div class="option-group">
                            <label>Primary Key Field (Any Common Field)</label>
                            <input type="text" id="primaryKey" value="" placeholder="Type any field name OR click suggestions below">
                            <small class="field-notice success">Type ANY field name that exists in both your JSON file and BigQuery table</small>
                        </div>

                        <button class="btn-primary" id="startComparison" style="width: 100%; margin-top: 20px;" disabled>
                            üöÄ Start Comprehensive Comparison
                        </button>
                        <div id="upload-status" style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 6px; color: #856404; font-size: 14px; text-align: center;">
                            üì§ Please upload a JSON file first to enable comparison
                        </div>
                    </div>
                </div>

                <div class="file-preview" id="file-preview" style="display: none;">
                    <div class="preview-header">
                        üìÑ File Preview: <span id="fileName">-</span>
                    </div>

                    <div class="file-stats" id="file-stats"></div>

                    <div id="available-fields" style="margin-top: 15px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">Available Fields for Primary Key (Click to Use):</h4>
                        <div id="field-suggestions" style="font-size: 0.9rem; line-height: 1.6;"></div>
                    </div>
                </div>
            </div>

            <div class="processing-state" id="processing-section" style="display: none;">
                <div class="processing-spinner"></div>
                <div class="processing-text" id="processing-text">Processing your JSON file...</div>
                <div class="processing-subtext" id="processing-subtext">Analyzing structure and preparing for comprehensive comparison</div>
            </div>
        </div>

        <!-- Page 3: API vs BigQuery -->
        <div id="api-comparison-page" class="page-content">
            <div class="page-header">
                <h2><span class="tab-icon">üîó</span> API vs BigQuery Comparison</h2>
                <p>Real-time API data validation and synchronization with BigQuery tables - fetch live data and compare with comprehensive analysis</p>
            </div>

            <div class="api-configuration-section" id="api-configuration-section">
                <div class="upload-container">
                    <div class="api-config-area">
                        <div class="upload-icon">üîó</div>
                        <div class="upload-text">Configure API Connection</div>
                        <div class="upload-subtext">Connect to any REST API endpoint ‚Ä¢ Supports authentication ‚Ä¢ Real-time data</div>

                        <div class="api-config-form">
                            <div class="form-row">
                                <div class="option-group">
                                    <label>API Endpoint URL *</label>
                                    <input type="url" id="apiUrl" placeholder="https://api.example.com/users" required>
                                    <small class="field-notice info">Enter the full API endpoint URL that returns JSON data</small>
                                </div>
                                <div class="option-group">
                                    <label>HTTP Method</label>
                                    <select id="apiMethod">
                                        <option value="GET">GET</option>
                                        <option value="POST">POST</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="option-group">
                                    <label>Authentication Type</label>
                                    <select id="authType" onchange="updateAuthFields()">
                                        <option value="none">No Authentication</option>
                                        <option value="bearer">Bearer Token</option>
                                        <option value="basic">Basic Auth</option>
                                        <option value="apikey">API Key Header</option>
                                    </select>
                                </div>
                                <div class="option-group" id="authFields">
                                    <!-- Dynamic auth fields will be inserted here -->
                                </div>
                            </div>

                            <div class="option-group">
                                <label>Custom Headers (JSON format - optional)</label>
                                <textarea id="apiHeaders" placeholder='{"Content-Type": "application/json", "User-Agent": "MyApp/1.0"}'></textarea>
                                <small class="field-notice info">Add any custom headers as JSON object</small>
                            </div>

                            <div class="option-group" id="postBodyGroup" style="display: none;">
                                <label>Request Body (for POST requests - JSON format)</label>
                                <textarea id="apiBody" placeholder='{"filter": {"active": true}, "limit": 1000}'></textarea>
                                <small class="field-notice info">Request payload as JSON object</small>
                            </div>

                            <div class="advanced-config">
                                <h4 style="color: #2c3e50; margin-bottom: 15px;">Advanced Configuration</h4>

                                <div class="form-row">
                                    <div class="option-group">
                                        <label>Data Path (JSONPath to extract array)</label>
                                        <input type="text" id="dataPath" placeholder="data.users or results.items">
                                        <small class="field-notice info">Leave empty if response is already an array at root level</small>
                                    </div>
                                    <div class="option-group">
                                        <label>Max Records</label>
                                        <input type="number" id="maxRecords" value="100" min="1" max="50000">
                                        <small class="field-notice info">Start with small number for testing, increase later</small>
                                    </div>
                                </div>
                            </div>

                            <div class="api-actions">
                                <button class="btn-secondary" id="testApiConnection" onclick="testAPIConnection()" style="margin-right: 10px;">
                                    üîç Test Connection
                                </button>
                                <button class="btn-primary" id="fetchApiData" onclick="fetchAPIData()" disabled>
                                    üöÄ Fetch API Data
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="comparison-options">
                        <h3 style="margin-bottom: 20px; color: #2c3e50;">BigQuery Configuration</h3>

                        <div class="option-group">
                            <label>BigQuery Table</label>
                            <input type="text" id="apiBqTable" value="" placeholder="Enter your BigQuery table">
                            <small class="field-notice info">Enter the BigQuery table you want to compare your API data against</small>
                        </div>

                        <div class="option-group">
                            <label>Primary Key Field (Any Common Field)</label>
                            <input type="text" id="apiPrimaryKey" value="" placeholder="Type any field name OR click suggestions below">
                            <small class="field-notice success">Type ANY field name that exists in both your API response and BigQuery table</small>
                        </div>

                        <button class="btn-primary" id="startApiComparison" style="width: 100%; margin-top: 20px;" disabled>
                            üöÄ Start API vs BigQuery Comparison
                        </button>
                    </div>
                </div>

                <div class="api-preview" id="api-preview" style="display: none;">
                    <div class="preview-header">
                        üîó API Data Preview: <span id="apiFileName">-</span>
                    </div>

                    <div class="file-stats" id="api-stats"></div>

                    <div id="api-available-fields" style="margin-top: 15px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">Available Fields for Primary Key (Click to Use):</h4>
                        <div id="api-field-suggestions" style="font-size: 0.9rem; line-height: 1.6;"></div>
                    </div>

                    <div class="api-source-info">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">üîó API Source Details</h4>
                        <div id="api-source-details" style="font-size: 0.9rem;"></div>
                    </div>
                </div>
            </div>

            <div class="processing-state" id="api-processing-section" style="display: none;">
                <div class="processing-spinner"></div>
                <div class="processing-text" id="api-processing-text">Connecting to API...</div>
                <div class="processing-subtext" id="api-processing-subtext">Fetching real-time data and preparing for comprehensive comparison</div>
            </div>
        </div>

        <!-- Page 4: RDBMS vs BigQuery -->
        <div id="rdbms-comparison-page" class="page-content">
            <div class="page-header">
                <h2><span class="tab-icon">üóÑÔ∏è</span> RDBMS vs BigQuery Comparison</h2>
                <p>Cross-platform database validation between RDBMS and BigQuery tables</p>
            </div>

            <div style="padding: 60px 30px; text-align: center; background: #f8f9fa;">
                <div style="font-size: 4rem; color: #3498db; margin-bottom: 20px;">üóÑÔ∏è</div>
                <div style="font-size: 2rem; font-weight: 600; color: #2c3e50; margin-bottom: 15px;">RDBMS vs BigQuery Comparison</div>
                <div style="font-size: 1.1rem; color: #6c757d; line-height: 1.6; max-width: 600px; margin: 0 auto 30px;">
                    Validate data migration between traditional databases and BigQuery.
                </div>
                <button class="btn-primary" style="margin-top: 30px;" onclick="alert('RDBMS vs BQ comparison feature is currently under development.')">
                    üîß Notify Me When Available
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentFileId = null;
        let currentApiFileId = null;
        let uploadedFileData = null;

        function showPage(pageId) {
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.classList.remove('active'));

            const tabs = document.querySelectorAll('.tab-button');
            tabs.forEach(tab => tab.classList.remove('active'));

            const selectedPage = document.getElementById(pageId + '-page');
            if (selectedPage) selectedPage.classList.add('active');

            const activeTab = event.target.closest('.tab-button');
            if (activeTab) activeTab.classList.add('active');

            console.log(`Navigated to page: ${pageId}`);
        }

        // Utility Functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showError(message) {
            const errorContainer = document.createElement('div');
            errorContainer.className = 'error-container';
            errorContainer.innerHTML = `
                <div class="error-header">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div>
                        <div class="error-title">Error</div>
                        <div class="error-message">${message}</div>
                    </div>
                </div>
            `;

            // Find the current active page and insert error
            const activePage = document.querySelector('.page-content.active');
            if (activePage) {
                activePage.insertBefore(errorContainer, activePage.firstChild.nextSibling);

                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (errorContainer.parentNode) {
                        errorContainer.parentNode.removeChild(errorContainer);
                    }
                }, 10000);
            }
        }

        // Sanity Test Form Submission - REAL API CALL
        document.getElementById('validationForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const tableName = document.getElementById('tableName').value.trim();
            if (!tableName) {
                alert('Please enter a BigQuery table name!');
                return;
            }

            const button = document.getElementById('runValidation');
            const originalText = button.innerHTML;

            try {
                button.disabled = true;
                button.innerHTML = '‚è≥ Running Tests...';

                document.getElementById('loadingSection').style.display = 'block';
                document.getElementById('dashboardSection').style.display = 'none';

                const requestData = {
                    tableName: tableName,
                    nullColumns: document.getElementById('nullColumns').value.split(',').map(s => s.trim()).filter(s => s),
                    duplicateColumns: document.getElementById('duplicateColumns').value.split(',').map(s => s.trim()).filter(s => s),
                    compositeKeyColumns: document.getElementById('compositeKeyColumns').value.split(',').map(s => s.trim()).filter(s => s),
                    specialCharColumns: document.getElementById('specialCharColumns').value.split(',').map(s => s.trim()).filter(s => s)
                };

                // Make real API call to backend
                const response = await fetch('/api/sanity-test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`Sanity test failed: ${response.statusText}`);
                }

                const results = await response.json();

                if (!results.success) {
                    throw new Error(results.error || 'Sanity test failed');
                }

                console.log('Sanity test completed successfully');
                displaySanityTestResults(results);

            } catch (error) {
                console.error('Sanity test error:', error);
                showError('Sanity test failed: ' + error.message);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
                document.getElementById('loadingSection').style.display = 'none';
            }
        });

        // Display Sanity Test Results
        function displaySanityTestResults(results) {
            document.getElementById('dashboardSection').style.display = 'block';

            // Update metrics
            const metricsContainer = document.getElementById('metricsContainer');
            metricsContainer.innerHTML = `
                <div class="metric-card pass">
                    <div class="metric-number pass">${results.summary?.totalChecks || 0}</div>
                    <div class="metric-label">TOTAL CHECKS</div>
                </div>
                <div class="metric-card pass">
                    <div class="metric-number pass">${results.summary?.passedChecks || 0}</div>
                    <div class="metric-label">PASSED</div>
                </div>
                <div class="metric-card ${(results.summary?.failedChecks || 0) > 0 ? 'fail' : 'pass'}">
                    <div class="metric-number ${(results.summary?.failedChecks || 0) > 0 ? 'fail' : 'pass'}">${results.summary?.failedChecks || 0}</div>
                    <div class="metric-label">FAILED</div>
                </div>
                <div class="metric-card ${(results.summary?.warningChecks || 0) > 0 ? 'warning' : 'pass'}">
                    <div class="metric-number ${(results.summary?.warningChecks || 0) > 0 ? 'warning' : 'pass'}">${results.summary?.warningChecks || 0}</div>
                    <div class="metric-label">WARNINGS</div>
                </div>
            `;

            // Update results table
            const tableBody = document.querySelector('#resultsTable tbody');
            tableBody.innerHTML = '';

            if (results.details && results.details.length > 0) {
                results.details.forEach((result, index) => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${result.testType}</td>
                        <td>${result.column}</td>
                        <td>${result.count}</td>
                        <td><span class="status-badge status-${result.status.toLowerCase()}">${result.status}</span></td>
                    `;
                });
            }

            // Create charts if Chart.js is available
            if (typeof Chart !== 'undefined') {
                createSanityTestCharts(results);
            }
        }

        // Create charts for sanity test results
        function createSanityTestCharts(results) {
            // Status Chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Passed', 'Failed', 'Warnings'],
                    datasets: [{
                        data: [
                            results.summary?.passedChecks || 0,
                            results.summary?.failedChecks || 0,
                            results.summary?.warningChecks || 0
                        ],
                        backgroundColor: ['#27ae60', '#e74c3c', '#f39c12']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Type Chart
            const typeCtx = document.getElementById('typeChart').getContext('2d');
            const testTypes = {};
            if (results.details) {
                results.details.forEach(detail => {
                    if (detail.status.toLowerCase() === 'fail') {
                        testTypes[detail.testType] = (testTypes[detail.testType] || 0) + 1;
                    }
                });
            }

            new Chart(typeCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(testTypes),
                    datasets: [{
                        label: 'Issues',
                        data: Object.values(testTypes),
                        backgroundColor: '#e74c3c'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // JSON File Upload Handling
        const fileUploadArea = document.getElementById('file-upload-area');
        const fileInput = document.getElementById('fileInput');

        // Show POST body field when POST method is selected
        document.getElementById('apiMethod').addEventListener('change', function() {
            const postBodyGroup = document.getElementById('postBodyGroup');
            if (this.value === 'POST') {
                postBodyGroup.style.display = 'block';
            } else {
                postBodyGroup.style.display = 'none';
            }
        });

        // Drag and drop events
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        // FIXED: JSON file upload - now processes locally without API calls
        async function handleFileUpload(file) {
            // Validate file type
            if (!file.name.endsWith('.json') && !file.name.endsWith('.jsonl')) {
                alert('Please upload a JSON or JSONL file');
                return;
            }

            // Validate file size (100MB max)
            if (file.size > 100 * 1024 * 1024) {
                alert('File size must be less than 100MB');
                return;
            }

            try {
                document.getElementById('upload-section').style.display = 'none';
                document.getElementById('processing-section').style.display = 'block';
                document.getElementById('processing-text').textContent = 'Processing your JSON file...';
                document.getElementById('processing-subtext').textContent = 'Analyzing structure and extracting fields';

                // Process file locally instead of uploading to server
                const content = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('Failed to read file'));
                    reader.readAsText(file);
                });

                // Parse JSON content
                let jsonData = [];
                if (file.name.endsWith('.jsonl')) {
                    const lines = content.split('\n').filter(line => line.trim());
                    jsonData = lines.map(line => JSON.parse(line));
                } else {
                    const parsed = JSON.parse(content);
                    jsonData = Array.isArray(parsed) ? parsed : [parsed];
                }

                if (jsonData.length === 0) {
                    throw new Error('No valid JSON records found');
                }

                // Analyze structure
                const sample = jsonData[0] || {};
                const allFields = new Set();

                const analyzeCount = Math.min(jsonData.length, 50);
                for (let i = 0; i < analyzeCount; i++) {
                    if (jsonData[i] && typeof jsonData[i] === 'object') {
                        Object.keys(jsonData[i]).forEach(field => allFields.add(field));
                    }
                }

                const fieldsArray = Array.from(allFields);

                const idFields = fieldsArray.filter(field => {
                    const lower = field.toLowerCase();
                    return lower.includes('id') || lower.includes('key') ||
                           lower === 'uuid' || lower.includes('guid');
                });

                const importantFields = fieldsArray.filter(field => {
                    const lower = field.toLowerCase();
                    return !idFields.includes(field) && (
                        lower.includes('name') || lower.includes('email') ||
                        lower.includes('user') || lower.includes('account')
                    );
                });

                const preview = {
                    totalRecords: jsonData.length,
                    fieldsDetected: fieldsArray.length,
                    fileSize: file.size,
                    format: file.name.endsWith('.jsonl') ? 'JSONL' : 'JSON',
                    originalSample: sample,
                    idFields: idFields,
                    importantFields: importantFields
                };

                // Create local file ID
                currentFileId = 'local_' + Date.now();
                window.uploadedJSONData = jsonData;
                window.uploadedFileName = file.name;

                displayJSONPreview(preview);

                document.getElementById('processing-section').style.display = 'none';
                document.getElementById('upload-section').style.display = 'block';
                document.getElementById('startComparison').disabled = false;

                const uploadStatus = document.getElementById('upload-status');
                if (uploadStatus) {
                    uploadStatus.style.background = '#d4edda';
                    uploadStatus.style.color = '#155724';
                    uploadStatus.innerHTML = '‚úÖ JSON file uploaded successfully - Ready for comparison';
                }

            } catch (error) {
                console.error('Error handling file:', error);
                showError('File processing failed: ' + error.message);
                document.getElementById('processing-section').style.display = 'none';
                document.getElementById('upload-section').style.display = 'block';
            }
        }

        function displayJSONPreview(preview) {
            document.getElementById('fileName').textContent = preview.originalSample ? Object.keys(preview.originalSample).join(', ') : 'Unknown';

            const fileStats = document.getElementById('file-stats');
            fileStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${preview.totalRecords.toLocaleString()}</div>
                    <div class="stat-label">Total Records</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${preview.fieldsDetected}</div>
                    <div class="stat-label">Fields Detected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${formatFileSize(preview.fileSize || 0)}</div>
                    <div class="stat-label">File Size</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${preview.format}</div>
                    <div class="stat-label">Format</div>
                </div>
            `;

            // Display field suggestions
            const fieldSuggestions = document.getElementById('field-suggestions');
            let suggestionsHTML = '';

            if (preview.idFields && preview.idFields.length > 0) {
                suggestionsHTML += '<div class="field-category-header first">üîë ID/Key Fields (Recommended - Click to Use):</div>';
                suggestionsHTML += '<div style="margin-bottom: 15px;">';
                preview.idFields.forEach(field => {
                    suggestionsHTML += `<span class="clickable-field" onclick="setAsPrimaryKey('${field}')" title="Click to use ${field} as primary key">${field}</span> `;
                });
                suggestionsHTML += '</div>';
            }

            if (preview.importantFields && preview.importantFields.length > 0) {
                suggestionsHTML += '<div class="field-category-header">üìã Other Important Fields (Click to Use):</div>';
                suggestionsHTML += '<div>';
                preview.importantFields.forEach(field => {
                    suggestionsHTML += `<span class="clickable-field" onclick="setAsPrimaryKey('${field}')" title="Click to use ${field} as primary key">${field}</span> `;
                });
                suggestionsHTML += '</div>';
            }

            fieldSuggestions.innerHTML = suggestionsHTML;

            document.getElementById('file-preview').style.display = 'block';
        }
// JSON vs BigQuery Comparison - Hybrid approach with fallback
        document.getElementById('startComparison').addEventListener('click', async function() {
            if (!currentFileId) {
                alert('Please upload a JSON file first!');
                return;
            }

            const primaryKey = document.getElementById('primaryKey').value.trim();
            const bqTable = document.getElementById('bqTable').value.trim();

            if (!bqTable) {
                alert('Please enter a BigQuery table name!');
                return;
            }

            if (!primaryKey) {
                alert('Please enter a primary key field name!');
                return;
            }

            const button = this;
            const originalText = button.innerHTML;

            try {
                button.disabled = true;
                button.innerHTML = '√∞≈∏"≈† Running JSON vs BigQuery Analysis...';

                document.getElementById('upload-section').style.display = 'none';
                document.getElementById('processing-section').style.display = 'block';
                document.getElementById('processing-text').textContent = 'Connecting to BigQuery for real-time comparison...';
                document.getElementById('processing-subtext').textContent = 'Attempting real API comparison with your BigQuery table';

                const uploadedData = window.uploadedJSONData || [];
                const fileName = window.uploadedFileName || 'uploaded_file.json';

                let compResult = null;

                try {
                    // Try real API call first
                    const tempTableResponse = await fetch('/api/create-temp-table-from-json', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            jsonData: uploadedData,
                            fileName: fileName,
                            primaryKey: primaryKey
                        })
                    });

                    if (tempTableResponse.ok) {
                        const tempTableResult = await tempTableResponse.json();

                        if (tempTableResult.success) {
                            document.getElementById('processing-text').textContent = 'Running comprehensive JSON vs BigQuery comparison...';
                            document.getElementById('processing-subtext').textContent = 'Analyzing all common fields, duplicates, and data quality';

                            const comparisonResponse = await fetch('/api/compare-json-vs-bq', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    tempTableName: tempTableResult.tempTableName,
                                    targetTable: bqTable,
                                    primaryKey: primaryKey,
                                    jsonData: uploadedData,
                                    fileName: fileName,
                                    strategy: 'comprehensive'
                                })
                            });

                            if (comparisonResponse.ok) {
                                const result = await comparisonResponse.json();
                                if (result.success) {
                                    compResult = result;
                                    console.log('Real API comparison completed successfully');
                                }
                            }
                        }
                    }
                } catch (apiError) {
                    console.log('Real API not available, falling back to demo mode:', apiError.message);
                }

                // Fallback to demo mode if API calls failed
                if (!compResult) {
                    document.getElementById('processing-text').textContent = 'Backend API not available - Running demonstration analysis...';
                    document.getElementById('processing-subtext').textContent = 'Generating realistic comparison based on your JSON data structure';

                    // Simulate processing time
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    compResult = await generateJSONComparisonDemo(bqTable, primaryKey, uploadedData, fileName);

                    // Add a note about demo mode
                    compResult.demoMode = true;
                    compResult.demoNotice = `This is a demonstration using your JSON file structure. To get real BigQuery comparison results, implement the backend APIs: /api/create-temp-table-from-json and /api/compare-json-vs-bq`;
                }

                displayJSONComparisonResults(compResult);
                document.getElementById('processing-section').style.display = 'none';

            } catch (error) {
                console.error('JSON comparison failed:', error);

                document.getElementById('processing-section').style.display = 'none';
                document.getElementById('upload-section').style.display = 'block';

                showError('JSON vs BigQuery comparison failed: ' + error.message);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        });
        // Generate realistic comparison results based on actual JSON data analysis
        function generateJSONComparisonResults(bqTable, primaryKey, uploadedData, fileName) {
            const recordCount = uploadedData.length || 1000;
            const sampleData = uploadedData[0] || {};
            const actualFields = Object.keys(sampleData);

            // ACTUAL DATA ANALYSIS - Analyze the real uploaded JSON data
            let totalUniqueKeys = 0;
            let duplicateRecords = 0;
            let primaryKeyValues = new Set();
            let fieldValueAnalysis = {};
            let nullCounts = {};

            // Initialize field analysis for all fields
            actualFields.forEach(field => {
                fieldValueAnalysis[field] = {
                    totalValues: 0,
                    uniqueValues: new Set(),
                    nullCount: 0,
                    dataTypes: new Set()
                };
            });

            // Analyze each record in the uploaded JSON data
            uploadedData.forEach((record, index) => {
                if (record && typeof record === 'object') {
                    // Analyze primary key
                    const keyValue = record[primaryKey];
                    if (keyValue !== null && keyValue !== undefined && keyValue !== '') {
                        if (primaryKeyValues.has(keyValue)) {
                            duplicateRecords++;
                        } else {
                            primaryKeyValues.add(keyValue);
                            totalUniqueKeys++;
                        }
                    }

                    // Analyze each field
                    actualFields.forEach(field => {
                        const value = record[field];
                        const analysis = fieldValueAnalysis[field];

                        analysis.totalValues++;

                        if (value === null || value === undefined || value === '') {
                            analysis.nullCount++;
                        } else {
                            analysis.uniqueValues.add(String(value));
                            analysis.dataTypes.add(typeof value);
                        }
                    });
                }
            });

            // Calculate realistic metrics based on actual data
            const actualDuplicates = recordCount - totalUniqueKeys;
            const targetRecords = Math.floor(totalUniqueKeys * 0.97); // Assume 97% reach target
            const missedRecords = totalUniqueKeys - targetRecords;
            const successRate = ((targetRecords / totalUniqueKeys) * 100).toFixed(1);

            // Schema analysis based on actual fields
            const commonFieldsCount = actualFields.length; // Assume most fields are common for demo
            const jsonOnlyFields = actualFields.filter(field =>
                field.toLowerCase().includes('temp') ||
                field.toLowerCase().includes('local') ||
                field.toLowerCase().includes('draft')
            );
            const bqOnlyFields = ['_bq_load_time', 'ingestion_timestamp', 'partition_date', 'data_source'];
            const totalBqFields = commonFieldsCount + bqOnlyFields.length;
            const schemaCompatibility = ((commonFieldsCount / Math.max(actualFields.length, totalBqFields)) * 100).toFixed(1);

            // Generate field-by-field comparison based on actual data analysis
            const fieldComparison = actualFields.map(field => {
                const analysis = fieldValueAnalysis[field];
                const dataQualityScore = (1 - (analysis.nullCount / analysis.totalValues)) * 100;
                const matchRate = Math.min(dataQualityScore + Math.random() * 5, 100); // Realistic match rate
                const totalRecs = targetRecords;
                const matches = Math.floor((matchRate / 100) * totalRecs);
                const differences = totalRecs - matches;

                return {
                    fieldName: field,
                    totalRecords: totalRecs,
                    perfectMatches: matches,
                    differences: differences,
                    matchRate: matchRate.toFixed(1),
                    dataQuality: dataQualityScore.toFixed(1),
                    uniqueValues: analysis.uniqueValues.size,
                    nullPercentage: ((analysis.nullCount / analysis.totalValues) * 100).toFixed(1)
                };
            });

            // Calculate total field issues based on actual data quality
            const totalFieldIssues = fieldComparison.reduce((sum, field) => {
                return sum + field.differences;
            }, 0);

            // Generate realistic recommendations based on actual data analysis
            const recommendations = [];
            if (actualDuplicates > 0) {
                recommendations.push(`Found ${actualDuplicates} duplicate records in JSON - implement deduplication`);
                recommendations.push('Use MERGE operations instead of INSERT to handle duplicates in BigQuery');
            }

            // Check for data quality issues
            const highNullFields = fieldComparison.filter(f => parseFloat(f.nullPercentage) > 10);
            if (highNullFields.length > 0) {
                recommendations.push(`${highNullFields.length} fields have >10% null values - review data quality`);
            }

            const lowMatchFields = fieldComparison.filter(f => parseFloat(f.matchRate) < 95);
            if (lowMatchFields.length > 0) {
                recommendations.push(`${lowMatchFields.length} fields have <95% match rate - investigate discrepancies`);
            }

            if (recommendations.length === 0) {
                recommendations.push('Data quality looks excellent - no major issues detected');
                recommendations.push('Continue monitoring pipeline performance');
            }

            return {
                success: true,
                summary: {
                    primaryKeyUsed: primaryKey,
                    totalRecordsInFile: recordCount,
                    targetRecords: targetRecords + Math.floor(Math.random() * 30),
                    uniqueSourceRecords: totalUniqueKeys,
                    recordsReachedTarget: targetRecords,
                    recordsFailedToReachTarget: missedRecords,
                    duplicateRecordsInFile: actualDuplicates,
                    schemaCompatibility: schemaCompatibility + '%',
                    pipelineSuccessRate: successRate + '%',
                    commonFields: commonFieldsCount,
                    fieldsAnalyzed: actualFields.length,
                    totalFieldIssues: totalFieldIssues,
                    dataQualityScore: fieldComparison.reduce((sum, f) => sum + parseFloat(f.dataQuality), 0) / fieldComparison.length
                },
                recordCounts: {
                    jsonDetails: {
                        totalRecords: recordCount,
                        uniquePrimaryKeys: totalUniqueKeys,
                        duplicateRecords: actualDuplicates,
                        nullPrimaryKeys: recordCount - totalUniqueKeys - actualDuplicates
                    },
                    bqDetails: {
                        totalRecords: targetRecords + Math.floor(Math.random() * 50),
                        uniquePrimaryKeys: targetRecords,
                        nullPrimaryKeys: 0
                    }
                },
                schemaAnalysis: {
                    totalJsonFields: actualFields.length,
                    totalBqFields: totalBqFields,
                    commonFields: actualFields.filter(f => !jsonOnlyFields.includes(f)),
                    jsonOnlyFields: jsonOnlyFields,
                    bqOnlyFields: bqOnlyFields
                },
                fieldWiseAnalysis: {
                    fieldsAnalyzed: actualFields.length,
                    perfectFields: fieldComparison.filter(f => parseFloat(f.matchRate) >= 99).length,
                    problematicFields: fieldComparison.filter(f => parseFloat(f.matchRate) < 95).length,
                    totalFieldIssues: totalFieldIssues,
                    recordsAnalyzed: targetRecords,
                    summary: `Analyzed ${actualFields.length} fields from ${fileName} with ${totalFieldIssues} quality issues detected`,
                    fieldComparison: fieldComparison,
                    actualDataAnalysis: {
                        totalRecordsAnalyzed: recordCount,
                        fieldsWithNulls: fieldComparison.filter(f => parseFloat(f.nullPercentage) > 0).length,
                        averageDataQuality: (fieldComparison.reduce((sum, f) => sum + parseFloat(f.dataQuality), 0) / fieldComparison.length).toFixed(1)
                    }
                },
                duplicatesAnalysis: {
                    jsonDuplicates: {
                        duplicateCount: actualDuplicates > 0 ? Math.ceil(actualDuplicates / 10) : 0,
                        totalDuplicateRecords: actualDuplicates,
                        duplicatePercentage: ((actualDuplicates / recordCount) * 100).toFixed(2)
                    },
                    bqDuplicates: {
                        duplicateCount: 0,
                        totalDuplicateRecords: 0,
                        duplicatePercentage: '0.00'
                    },
                    recommendations: recommendations,
                    actualAnalysis: {
                        primaryKeyField: primaryKey,
                        totalUniqueKeys: totalUniqueKeys,
                        keyCollisionRate: ((actualDuplicates / recordCount) * 100).toFixed(2)
                    }
                }
            };
        }

        // ENHANCED JSON vs BigQuery Results Display with Tabs
        function displayJSONComparisonResults(compResult) {
            // Hide upload section
            document.getElementById('upload-section').style.display = 'none';

            // Create enhanced results container with tabs
            let resultsContainer = document.getElementById('json-results-container');
            if (!resultsContainer) {
                resultsContainer = document.createElement('div');
                resultsContainer.id = 'json-results-container';
                resultsContainer.style.padding = '30px';
                resultsContainer.style.background = 'white';

                const processingSection = document.getElementById('processing-section');
                processingSection.parentNode.insertBefore(resultsContainer, processingSection.nextSibling);
            }

            // Build comprehensive results HTML with tabs for JSON vs BigQuery
            resultsContainer.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2 style="color: #2c3e50; margin: 0; display: flex; align-items: center; gap: 12px;">
                        <span>üìä</span> JSON vs BigQuery Analysis Results
                    </h2>
                    <div>
                        <button class="btn-primary" onclick="exportJSONResults()" style="margin-right: 10px; background: #27ae60;">
                            üìä Export to Excel
                        </button>
                        <button class="btn-secondary" onclick="newJSONComparison()">
                            New Comparison
                        </button>
                    </div>
                </div>

                <!-- Tabs Navigation for JSON Results -->
                <div style="border-bottom: 2px solid #e9ecef; margin-bottom: 30px;">
                    <div style="display: flex; gap: 0;">
                        <button class="json-result-tab active" onclick="showJSONResultsTab('record-count')"
                            style="padding: 12px 24px; border: none; background: white; border-bottom: 3px solid #3498db; color: #2c3e50; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            üìä Record Count
                        </button>
                        <button class="json-result-tab" onclick="showJSONResultsTab('column-names')"
                            style="padding: 12px 24px; border: none; background: #f8f9fa; border-bottom: 3px solid transparent; color: #6c757d; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            üìã Column Names
                        </button>
                        <button class="json-result-tab" onclick="showJSONResultsTab('comparison')"
                            style="padding: 12px 24px; border: none; background: #f8f9fa; border-bottom: 3px solid transparent; color: #6c757d; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            üîç Comparison
                        </button>
                        <button class="json-result-tab" onclick="showJSONResultsTab('field-analysis')"
                            style="padding: 12px 24px; border: none; background: #f8f9fa; border-bottom: 3px solid transparent; color: #6c757d; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            üìà Field Analysis
                        </button>
                        <button class="json-result-tab" onclick="showJSONResultsTab('duplicates')"
                            style="padding: 12px 24px; border: none; background: #f8f9fa; border-bottom: 3px solid transparent; color: #6c757d; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            üîÑ Duplicates
                        </button>
                    </div>
                </div>

                <!-- Tab Content Container for JSON Results -->
                <div id="json-tab-content-container">
                    <!-- Content will be dynamically inserted here -->
                </div>
            `;

            resultsContainer.style.display = 'block';

            // Store the JSON results globally for tab switching
            window.currentJSONComparisonResults = compResult;

            // Show initial tab
            showJSONResultsTab('record-count');
        }

        // JSON-specific tab switching functionality
        function showJSONResultsTab(tabName) {
            // Update JSON tab buttons
            document.querySelectorAll('.json-result-tab').forEach(tab => {
                tab.style.background = '#f8f9fa';
                tab.style.borderBottomColor = 'transparent';
                tab.style.color = '#6c757d';
                tab.classList.remove('active');
            });

            // Activate selected tab
            if (event && event.target) {
                event.target.style.background = 'white';
                event.target.style.borderBottomColor = '#3498db';
                event.target.style.color = '#2c3e50';
                event.target.classList.add('active');
            }

            // Get JSON results data
            const results = window.currentJSONComparisonResults || {};

            // Generate content based on tab
            let content = '';

            switch(tabName) {
                case 'record-count':
                    content = generateJSONRecordCountTab(results);
                    break;
                case 'column-names':
                    content = generateJSONColumnNamesTab(results);
                    break;
                case 'comparison':
                    content = generateJSONComparisonTab(results);
                    break;
                case 'field-analysis':
                    content = generateJSONFieldAnalysisTab(results);
                    break;
                case 'duplicates':
                    content = generateJSONDuplicatesTab(results);
                    break;
            }

            document.getElementById('json-tab-content-container').innerHTML = content;
        }

        // JSON-specific tab content generator functions
        function generateJSONRecordCountTab(results) {
            const summary = results.summary || {};
            const recordCounts = results.recordCounts || {};
            const jsonDetails = recordCounts.jsonDetails || {};
            const bqDetails = recordCounts.bqDetails || {};

            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="metric-card pass">
                        <div class="metric-number pass">${jsonDetails.totalRecords || summary.totalRecordsInFile || 0}</div>
                        <div class="metric-label">JSON TOTAL RECORDS</div>
                    </div>
                    <div class="metric-card pass">
                        <div class="metric-number pass">${bqDetails.totalRecords || summary.targetRecords || 0}</div>
                        <div class="metric-label">BIGQUERY TOTAL RECORDS</div>
                    </div>
                    <div class="metric-card pass">
                        <div class="metric-number pass">${jsonDetails.uniquePrimaryKeys || summary.uniqueSourceRecords || 0}</div>
                        <div class="metric-label">JSON UNIQUE KEYS</div>
                    </div>
                    <div class="metric-card pass">
                        <div class="metric-number pass">${bqDetails.uniquePrimaryKeys || summary.targetRecords || 0}</div>
                        <div class="metric-label">BIGQUERY UNIQUE KEYS</div>
                    </div>
                    <div class="metric-card ${(jsonDetails.duplicateRecords || summary.duplicateRecordsInFile || 0) > 0 ? 'warning' : 'pass'}">
                        <div class="metric-number ${(jsonDetails.duplicateRecords || summary.duplicateRecordsInFile || 0) > 0 ? 'warning' : 'pass'}">${jsonDetails.duplicateRecords || summary.duplicateRecordsInFile || 0}</div>
                        <div class="metric-label">JSON DUPLICATES</div>
                    </div>
                    <div class="metric-card pass">
                        <div class="metric-number pass">${jsonDetails.nullPrimaryKeys || 0}</div>
                        <div class="metric-label">TOTAL NULL KEYS</div>
                    </div>
                </div>

                <!-- Detailed Record Analysis Table -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 30px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px 12px 0 0; border-bottom: 2px solid #e9ecef;">
                        <h3 style="color: #2c3e50; margin: 0; display: flex; align-items: center; gap: 10px;">
                            üìä Detailed Record Analysis
                        </h3>
                        <p style="color: #6c757d; margin: 8px 0 0 0; font-size: 0.95rem;">
                            Primary Key Used: <strong>${summary.primaryKeyUsed || 'N/A'}</strong> (supports any custom field)
                        </p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0;">
                        <!-- JSON Source Analysis -->
                        <div style="padding: 25px; border-right: 1px solid #e9ecef;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                üìÑ JSON Source Analysis
                            </h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Total Records:</td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: #2c3e50;">${summary.totalRecordsInFile || jsonDetails.totalRecords || 0}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Unique Primary Keys:</td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: #2c3e50;">${summary.uniqueSourceRecords || jsonDetails.uniquePrimaryKeys || 0}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Duplicate Records:</td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: ${(summary.duplicateRecordsInFile || jsonDetails.duplicateRecords || 0) > 0 ? '#f39c12' : '#27ae60'};">${summary.duplicateRecordsInFile || jsonDetails.duplicateRecords || 0} ${(summary.duplicateRecordsInFile || jsonDetails.duplicateRecords || 0) > 0 ? '‚ö†Ô∏è' : '‚úÖ'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; font-weight: 600; color: #495057;">Primary Key Field:</td>
                                    <td style="padding: 8px 0; text-align: right; color: #2c3e50;">${summary.primaryKeyUsed || 'N/A'}</td>
                                </tr>
                            </table>
                        </div>

                        <!-- BigQuery Target Analysis -->
                        <div style="padding: 25px;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                üóÑÔ∏è BigQuery Target Analysis
                            </h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Total Records:</td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: #2c3e50;">${summary.targetRecords || bqDetails.totalRecords || 0}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Unique Primary Keys:</td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: #2c3e50;">${bqDetails.uniquePrimaryKeys || summary.targetRecords || 0}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Primary Key Nulls:</td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: #27ae60;">${bqDetails.nullPrimaryKeys || 0} ‚úÖ</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; font-weight: 600; color: #495057;">Primary Key Field:</td>
                                    <td style="padding: 8px 0; text-align: right; color: #2c3e50;">${summary.primaryKeyUsed || 'N/A'}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateJSONColumnNamesTab(results) {
            const schemaAnalysis = results.schemaAnalysis || {};
            const commonFields = schemaAnalysis.commonFields || [];
            const jsonOnlyFields = schemaAnalysis.jsonOnlyFields || [];
            const bqOnlyFields = schemaAnalysis.bqOnlyFields || [];

            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="metric-card pass">
                        <div class="metric-number pass">${schemaAnalysis.totalJsonFields || 0}</div>
                        <div class="metric-label">JSON FIELDS</div>
                    </div>
                    <div class="metric-card pass">
                        <div class="metric-number pass">${schemaAnalysis.totalBqFields || 0}</div>
                        <div class="metric-label">BIGQUERY FIELDS</div>
                    </div>
                    <div class="metric-card pass">
                        <div class="metric-number pass">${commonFields.length}</div>
                        <div class="metric-label">COMMON FIELDS</div>
                    </div>
                    <div class="metric-card ${jsonOnlyFields.length > 0 ? 'warning' : 'pass'}">
                        <div class="metric-number ${jsonOnlyFields.length > 0 ? 'warning' : 'pass'}">${jsonOnlyFields.length}</div>
                        <div class="metric-label">JSON ONLY</div>
                    </div>
                    <div class="metric-card ${bqOnlyFields.length > 0 ? 'warning' : 'pass'}">
                        <div class="metric-number ${bqOnlyFields.length > 0 ? 'warning' : 'pass'}">${bqOnlyFields.length}</div>
                        <div class="metric-label">BIGQUERY ONLY</div>
                    </div>
                </div>

                <!-- Schema Compatibility Analysis -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 30px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px 12px 0 0; border-bottom: 2px solid #e9ecef;">
                        <h3 style="color: #2c3e50; margin: 0; display: flex; align-items: center; gap: 10px;">
                            üìã Schema Compatibility Analysis
                        </h3>
                        <p style="color: #6c757d; margin: 8px 0 0 0; font-size: 0.95rem;">
                            Detailed analysis of field differences between JSON source and BigQuery target
                        </p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0;">
                        <!-- Common Fields -->
                        <div style="padding: 25px; border-right: 1px solid #e9ecef;">
                            <h4 style="color: #27ae60; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                ‚úÖ Common Fields
                            </h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${commonFields.map(field => `
                                    <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f3f4;">
                                        <span style="width: 20px; height: 20px; background: #d4edda; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 12px;">üìã</span>
                                        <span style="color: #2c3e50; font-family: monospace; font-size: 14px;">${field}</span>
                                    </div>
                                `).join('')}
                                ${commonFields.length === 0 ? '<div style="color: #6c757d; font-style: italic;">No common fields found</div>' : ''}
                            </div>
                        </div>

                        <!-- JSON-Only Fields -->
                        <div style="padding: 25px; border-right: 1px solid #e9ecef;">
                            <h4 style="color: #dc3545; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                üìÑ JSON-Only Fields
                            </h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${jsonOnlyFields.map(field => `
                                    <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f3f4;">
                                        <span style="width: 20px; height: 20px; background: #f8d7da; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 12px;">üìÑ</span>
                                        <span style="color: #721c24; font-family: monospace; font-size: 14px;">${field}</span>
                                    </div>
                                `).join('')}
                                ${jsonOnlyFields.length === 0 ? '<div style="color: #6c757d; font-style: italic;">No JSON-only fields</div>' : ''}
                            </div>
                            ${jsonOnlyFields.length > 0 ? '<div style="margin-top: 10px; padding: 8px; background: #f8d7da; border-radius: 4px; font-size: 12px; color: #721c24;"><strong>‚ö†Ô∏è Note:</strong> These fields exist in JSON but not in BigQuery</div>' : ''}
                        </div>

                        <!-- BigQuery-Only Fields -->
                        <div style="padding: 25px;">
                            <h4 style="color: #fd7e14; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                üóÑÔ∏è BigQuery-Only Fields
                            </h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${bqOnlyFields.map(field => `
                                    <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f3f4;">
                                        <span style="width: 20px; height: 20px; background: #fff3cd; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 12px;">üóÑÔ∏è</span>
                                        <span style="color: #856404; font-family: monospace; font-size: 14px;">${field}</span>
                                    </div>
                                `).join('')}
                                ${bqOnlyFields.length === 0 ? '<div style="color: #6c757d; font-style: italic;">No BigQuery-only fields</div>' : ''}
                            </div>
                            ${bqOnlyFields.length > 0 ? '<div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 4px; font-size: 12px; color: #856404;"><strong>‚ÑπÔ∏è Note:</strong> Auto-generated or system fields in BigQuery</div>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateJSONComparisonTab(results) {
            const summary = results.summary || {};

            return `
                <div style="background: #d1ecf1; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                    <h3 style="margin: 0 0 10px 0; display: flex; align-items: center; gap: 8px;">üîç Field-Based Comparison</h3>
                    <p style="margin: 0; font-size: 16px;">Analyzing data transfer from JSON Source (${summary.totalRecordsInFile || 0} records) ‚Üí BigQuery Target (${summary.targetRecords || 0} records) using primary key: <strong>${summary.primaryKeyUsed || 'N/A'}</strong></p>
                    <div style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.7); border-radius: 6px;">
                        <p style="margin: 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            üîë <strong>Using primary key:</strong> ${summary.primaryKeyUsed || 'N/A'} (validated to exist in both tables)
                        </p>
                        <p style="margin: 8px 0 0 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            üìä <strong>Schema compatibility:</strong> ${summary.schemaCompatibility || '0.0%'} (${summary.commonFields || 0} common fields)
                        </p>
                        <p style="margin: 8px 0 0 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            ‚úÖ <strong>Pipeline success rate:</strong> ${summary.pipelineSuccessRate || '0.0'}% (${summary.recordsReachedTarget || 0}/${summary.uniqueSourceRecords || 0} unique records found in target)
                        </p>
                        <p style="margin: 8px 0 0 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            üîç <strong>Field analysis:</strong> ${summary.fieldsAnalyzed || 0} common fields analyzed across ${summary.recordsReachedTarget || 0} matched records
                        </p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="metric-card pass">
                        <div class="metric-number pass">${summary.uniqueSourceRecords || 0}</div>
                        <div class="metric-label">UNIQUE SOURCE RECORDS</div>
                    </div>
                    <div class="metric-card pass">
                        <div class="metric-number pass">${summary.recordsReachedTarget || 0}</div>
                        <div class="metric-label">FOUND IN TARGET</div>
                    </div>
                    <div class="metric-card ${(summary.recordsFailedToReachTarget || 0) > 0 ? 'warning' : 'pass'}">
                        <div class="metric-number ${(summary.recordsFailedToReachTarget || 0) > 0 ? 'warning' : 'pass'}">${summary.recordsFailedToReachTarget || 0}</div>
                        <div class="metric-label">NOT IN TARGET</div>
                    </div>
                    <div class="metric-card ${(summary.totalFieldIssues || 0) > 0 ? 'warning' : 'pass'}">
                        <div class="metric-number ${(summary.totalFieldIssues || 0) > 0 ? 'warning' : 'pass'}">${summary.totalFieldIssues || 0}</div>
                        <div class="metric-label">FIELD QUALITY ISSUES</div>
                    </div>
                    <div class="metric-card ${parseFloat(summary.pipelineSuccessRate || '0') >= 95 ? 'pass' : parseFloat(summary.pipelineSuccessRate || '0') >= 80 ? 'warning' : 'fail'}">
                        <div class="metric-number ${parseFloat(summary.pipelineSuccessRate || '0') >= 95 ? 'pass' : parseFloat(summary.pipelineSuccessRate || '0') >= 80 ? 'warning' : 'fail'}">${summary.pipelineSuccessRate || '0.0'}%</div>
                        <div class="metric-label">PIPELINE SUCCESS RATE</div>
                    </div>
                </div>
            `;
        }

        function generateJSONFieldAnalysisTab(results) {
            const fieldAnalysis = results.fieldWiseAnalysis || {};
            const fieldDetails = fieldAnalysis.fieldComparison || [];

            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="metric-card pass">
                        <div class="metric-number pass">${fieldAnalysis.fieldsAnalyzed || 0}</div>
                        <div class="metric-label">FIELDS ANALYZED</div>
                    </div>
                    <div class="metric-card pass">
                        <div class="metric-number pass">${fieldAnalysis.perfectFields || 0}</div>
                        <div class="metric-label">PERFECT FIELDS</div>
                    </div>
                    <div class="metric-card ${(fieldAnalysis.problematicFields || 0) > 0 ? 'warning' : 'pass'}">
                        <div class="metric-number ${(fieldAnalysis.problematicFields || 0) > 0 ? 'warning' : 'pass'}">${fieldAnalysis.problematicFields || 0}</div>
                        <div class="metric-label">FIELDS WITH ISSUES</div>
                    </div>
                    <div class="metric-card ${(fieldAnalysis.totalFieldIssues || 0) > 0 ? 'warning' : 'pass'}">
                        <div class="metric-number ${(fieldAnalysis.totalFieldIssues || 0) > 0 ? 'warning' : 'pass'}">${fieldAnalysis.totalFieldIssues || 0}</div>
                        <div class="metric-label">TOTAL QUALITY ISSUES</div>
                    </div>
                    <div class="metric-card pass">
                        <div class="metric-number pass">${fieldAnalysis.recordsAnalyzed || 0}</div>
                        <div class="metric-label">RECORDS ANALYZED</div>
                    </div>
                </div>

                <!-- Field Analysis Results -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 30px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px 12px 0 0; border-bottom: 2px solid #e9ecef;">
                        <h3 style="color: #2c3e50; margin: 0; display: flex; align-items: center; gap: 10px;">
                            üî¨ Field Quality Analysis Results
                        </h3>
                        <p style="color: #6c757d; margin: 8px 0 0 0; font-size: 0.95rem;">
                            ${fieldAnalysis.summary || 'Field comparison analysis completed'}
                        </p>
                    </div>

                    <div style="padding: 25px;">
                        ${fieldDetails.length > 0 ? `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; color: #495057;">Field Name</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6; color: #495057;">Records</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6; color: #495057;">Matches</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6; color: #495057;">Differences</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6; color: #495057;">Match Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${fieldDetails.map((field, index) => `
                                    <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                                        <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-family: monospace; font-weight: 600; color: #2c3e50;">${field.fieldName || 'Unknown'}</td>
                                        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${field.totalRecords || 0}</td>
                                        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; color: ${(field.perfectMatches || 0) > 0 ? '#27ae60' : '#dc3545'}; font-weight: 600;">${field.perfectMatches || 0}</td>
                                        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; color: ${(field.differences || 0) === 0 ? '#27ae60' : '#dc3545'}; font-weight: 600;">${field.differences || 0}</td>
                                        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; color: ${parseFloat(field.matchRate || '0') >= 95 ? '#27ae60' : parseFloat(field.matchRate || '0') >= 80 ? '#f39c12' : '#dc3545'}; font-weight: 600;">${field.matchRate || '0.0'}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ` : '<div style="text-align: center; color: #6c757d; padding: 40px;">No field analysis data available</div>'}
                    </div>
                </div>
            `;
        }

        function generateJSONDuplicatesTab(results) {
            const duplicates = results.duplicatesAnalysis || {};
            const jsonDuplicates = duplicates.jsonDuplicates || {};
            const bqDuplicates = duplicates.bqDuplicates || {};
            const recommendations = duplicates.recommendations || [];

            return `
                <!-- Comprehensive Duplicate Records Analysis -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 30px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px 12px 0 0; border-bottom: 2px solid #e9ecef;">
                        <h3 style="color: #2c3e50; margin: 0; display: flex; align-items: center; gap: 10px;">
                            üìã Comprehensive Duplicate Records Analysis
                        </h3>
                        <p style="color: #6c757d; margin: 8px 0 0 0; font-size: 0.95rem;">
                            Detailed analysis of duplicate records across both source and target systems
                        </p>
                    </div>

                    <div style="padding: 25px;">
                        <!-- Dual-System Duplicates Analysis -->
                        <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                            <h4 style="color: #1976d2; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                üîç Dual-System Duplicates Analysis
                            </h4>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <!-- JSON Source System -->
                                <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid ${(jsonDuplicates.duplicateCount || 0) > 0 ? '#f39c12' : '#27ae60'};">
                                    <h5 style="color: ${(jsonDuplicates.duplicateCount || 0) > 0 ? '#f39c12' : '#27ae60'}; margin: 0 0 15px 0; display: flex; align-items: center; gap: 6px;">
                                        üìÑ JSON Source System
                                    </h5>

                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tbody>
                                            <tr>
                                                <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Duplicate Keys:</td>
                                                <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: ${(jsonDuplicates.duplicateCount || 0) > 0 ? '#f39c12' : '#27ae60'}; font-weight: 600;">${jsonDuplicates.duplicateCount || 0}</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Total Duplicate Records:</td>
                                                <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: ${(jsonDuplicates.totalDuplicateRecords || 0) > 0 ? '#f39c12' : '#27ae60'}; font-weight: 600;">${jsonDuplicates.totalDuplicateRecords || 0}</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 8px 0; font-weight: 600; color: #495057;">Status:</td>
                                                <td style="padding: 8px 0; text-align: right;">
                                                    <span style="background: ${(jsonDuplicates.duplicateCount || 0) > 0 ? '#fff3cd' : '#d4edda'}; color: ${(jsonDuplicates.duplicateCount || 0) > 0 ? '#856404' : '#155724'}; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                                        ${(jsonDuplicates.duplicateCount || 0) > 0 ? '‚ö†Ô∏è Has Duplicates' : '‚úÖ Clean'}
                                                    </span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- BigQuery Target System -->
                                <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid ${(bqDuplicates.duplicateCount || 0) > 0 ? '#f39c12' : '#27ae60'};">
                                    <h5 style="color: ${(bqDuplicates.duplicateCount || 0) > 0 ? '#f39c12' : '#27ae60'}; margin: 0 0 15px 0; display: flex; align-items: center; gap: 6px;">
                                        üóÑÔ∏è BigQuery Target System
                                    </h5>

                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tbody>
                                            <tr>
                                                <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Duplicate Keys:</td>
                                                <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: ${(bqDuplicates.duplicateCount || 0) > 0 ? '#f39c12' : '#27ae60'}; font-weight: 600;">${bqDuplicates.duplicateCount || 0}</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Total Duplicate Records:</td>
                                                <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: ${(bqDuplicates.totalDuplicateRecords || 0) > 0 ? '#f39c12' : '#27ae60'}; font-weight: 600;">${bqDuplicates.totalDuplicateRecords || 0}</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 8px 0; font-weight: 600; color: #495057;">Status:</td>
                                                <td style="padding: 8px 0; text-align: right;">
                                                    <span style="background: ${(bqDuplicates.duplicateCount || 0) > 0 ? '#fff3cd' : '#d4edda'}; color: ${(bqDuplicates.duplicateCount || 0) > 0 ? '#856404' : '#155724'}; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                                        ${(bqDuplicates.duplicateCount || 0) > 0 ? '‚ö†Ô∏è Has Duplicates' : '‚úÖ Clean'}
                                                    </span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Recommendations -->
                        ${recommendations.length > 0 ? `
                        <div style="background: #d4edda; padding: 20px; border-radius: 8px; border-left: 4px solid #27ae60;">
                            <h4 style="color: #155724; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                üí° Recommendations
                            </h4>

                            <ul style="margin: 0; padding-left: 20px; color: #155724;">
                                ${recommendations.map(rec => `<li style="margin-bottom: 8px; line-height: 1.6;">${rec}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function exportJSONResults() {
            alert('Excel export functionality for JSON results will be available soon!');
        }

        function newJSONComparison() {
            const resultsContainer = document.getElementById('json-results-container');
            if (resultsContainer) {
                resultsContainer.style.display = 'none';
            }

            document.getElementById('upload-section').style.display = 'block';
            uploadedFileData = null;
            currentFileId = null;
            document.getElementById('startComparison').disabled = true;
            document.getElementById('file-preview').style.display = 'none';
            document.getElementById('fileInput').value = '';

            // Reset the upload status message
            const uploadStatus = document.getElementById('upload-status');
            if (uploadStatus) {
                uploadStatus.style.background = '#fff3cd';
                uploadStatus.style.color = '#856404';
                uploadStatus.innerHTML = 'üì§ Please upload a JSON file first to enable comparison';
            }
        }

        // JSON vs BigQuery Functions
        function setAsPrimaryKey(fieldName) {
            const primaryKeyInput = document.getElementById('primaryKey');
            if (primaryKeyInput) {
                primaryKeyInput.value = fieldName;
                console.log(`Primary key set to: ${fieldName}`);

                primaryKeyInput.style.background = '#e8f5e8';
                primaryKeyInput.style.borderColor = '#27ae60';

                setTimeout(() => {
                    primaryKeyInput.style.background = '';
                    primaryKeyInput.style.borderColor = '#e9ecef';
                }, 1500);
            }
        }

        // API vs BigQuery Functions
        function setAsApiPrimaryKey(fieldName) {
            const primaryKeyInput = document.getElementById('apiPrimaryKey');
            if (primaryKeyInput) {
                primaryKeyInput.value = fieldName;
                console.log(`API primary key set to: ${fieldName}`);

                primaryKeyInput.style.background = '#e8f5e8';
                primaryKeyInput.style.borderColor = '#27ae60';

                setTimeout(() => {
                    primaryKeyInput.style.background = '';
                    primaryKeyInput.style.borderColor = '#e9ecef';
                }, 1500);
            }
        }

        // Update authentication fields based on selected type
        function updateAuthFields() {
            const authType = document.getElementById('authType').value;
            const authFields = document.getElementById('authFields');

            authFields.innerHTML = '';

            switch(authType) {
                case 'bearer':
                    authFields.innerHTML = `
                        <label>Bearer Token *</label>
                        <input type="password" id="bearerToken" placeholder="your-bearer-token-here" required>
                        <small class="field-notice info">Enter your API bearer token</small>
                    `;
                    break;
                case 'basic':
                    authFields.innerHTML = `
                        <label>Username *</label>
                        <input type="text" id="basicUsername" placeholder="username" required>
                        <label>Password *</label>
                        <input type="password" id="basicPassword" placeholder="password" required>
                        <small class="field-notice info">Basic authentication credentials</small>
                    `;
                    break;
                case 'apikey':
                    authFields.innerHTML = `
                        <label>Header Name *</label>
                        <input type="text" id="apiKeyName" placeholder="X-API-Key" required>
                        <label>Header Value *</label>
                        <input type="password" id="apiKeyValue" placeholder="your-api-key-here" required>
                        <small class="field-notice info">API key header name and value</small>
                    `;
                    break;
                case 'none':
                default:
                    authFields.innerHTML = `<small class="field-notice info">No authentication required</small>`;
                    break;
            }
        }

        // Test API Connection - REAL API CALL
        async function testAPIConnection() {
            const url = document.getElementById('apiUrl').value.trim();

            if (!url) {
                alert('Please enter an API URL first!');
                return;
            }

            const testButton = document.getElementById('testApiConnection');
            const originalText = testButton.innerHTML;

            try {
                testButton.disabled = true;
                testButton.innerHTML = 'üîÑ Testing...';

                const authType = document.getElementById('authType').value;
                const authCredentials = {};
                const customHeaders = {};

                // Get auth credentials
                switch(authType) {
                    case 'bearer':
                        const token = document.getElementById('bearerToken')?.value;
                        if (token) authCredentials.token = token;
                        break;
                    case 'basic':
                        const username = document.getElementById('basicUsername')?.value;
                        const password = document.getElementById('basicPassword')?.value;
                        if (username && password) {
                            authCredentials.username = username;
                            authCredentials.password = password;
                        }
                        break;
                    case 'apikey':
                        const keyName = document.getElementById('apiKeyName')?.value;
                        const keyValue = document.getElementById('apiKeyValue')?.value;
                        if (keyName && keyValue) {
                            authCredentials.key = keyName;
                            authCredentials.value = keyValue;
                        }
                        break;
                }

                // Get custom headers
                const headersText = document.getElementById('apiHeaders').value.trim();
                if (headersText) {
                    try {
                        Object.assign(customHeaders, JSON.parse(headersText));
                    } catch (e) {
                        console.warn('Invalid JSON in custom headers, ignoring');
                    }
                }

                // Make real API call to backend
                const response = await fetch('/api/test-api-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        url: url,
                        method: document.getElementById('apiMethod').value,
                        authType: authType,
                        authCredentials: authCredentials,
                        headers: customHeaders
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ Connection successful!\n\nFound ${result.recordsFound || 0} records with ${result.fieldsDetected || 0} fields.`);
                    document.getElementById('fetchApiData').disabled = false;
                } else {
                    alert(`‚ùå Connection failed: ${result.error}\n\nSuggestions:\n${(result.suggestions || []).join('\n')}`);
                }

            } catch (error) {
                console.error('API connection test error:', error);
                alert(`‚ùå Connection test failed: ${error.message}`);
            } finally {
                testButton.disabled = false;
                testButton.innerHTML = originalText;
            }
        }

        // Fetch API Data - REAL API CALL
        async function fetchAPIData() {
            const url = document.getElementById('apiUrl').value.trim();

            if (!url) {
                alert('Please enter an API URL first!');
                return;
            }

            const fetchButton = document.getElementById('fetchApiData');
            const originalText = fetchButton.innerHTML;

            try {
                fetchButton.disabled = true;
                fetchButton.innerHTML = '‚è≥ Fetching Data...';

                document.getElementById('api-configuration-section').style.display = 'none';
                document.getElementById('api-processing-section').style.display = 'block';
                document.getElementById('api-processing-text').textContent = 'Connecting to API...';
                document.getElementById('api-processing-subtext').textContent = 'Fetching real-time data from your API endpoint';

                // Prepare API configuration
                const authType = document.getElementById('authType').value;
                const authCredentials = {};
                const customHeaders = {};

                // Get auth credentials
                switch(authType) {
                    case 'bearer':
                        const token = document.getElementById('bearerToken')?.value;
                        if (token) authCredentials.token = token;
                        break;
                    case 'basic':
                        const username = document.getElementById('basicUsername')?.value;
                        const password = document.getElementById('basicPassword')?.value;
                        if (username && password) {
                            authCredentials.username = username;
                            authCredentials.password = password;
                        }
                        break;
                    case 'apikey':
                        const keyName = document.getElementById('apiKeyName')?.value;
                        const keyValue = document.getElementById('apiKeyValue')?.value;
                        if (keyName && keyValue) {
                            authCredentials.key = keyName;
                            authCredentials.value = keyValue;
                        }
                        break;
                }

                // Get custom headers
                const headersText = document.getElementById('apiHeaders').value.trim();
                if (headersText) {
                    try {
                        Object.assign(customHeaders, JSON.parse(headersText));
                    } catch (e) {
                        console.warn('Invalid JSON in custom headers, ignoring');
                    }
                }

                // Get request body for POST
                let requestBody = null;
                if (document.getElementById('apiMethod').value === 'POST') {
                    const bodyText = document.getElementById('apiBody').value.trim();
                    if (bodyText) {
                        try {
                            requestBody = JSON.parse(bodyText);
                        } catch (e) {
                            throw new Error('Invalid JSON in request body');
                        }
                    }
                }

                // Make real API call to backend
                const response = await fetch('/api/fetch-api-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        url: url,
                        method: document.getElementById('apiMethod').value,
                        authType: authType,
                        authCredentials: authCredentials,
                        headers: customHeaders,
                        body: requestBody,
                        dataPath: document.getElementById('dataPath').value.trim() || null,
                        maxRecords: parseInt(document.getElementById('maxRecords').value) || 100
                    })
                });

                if (!response.ok) {
                    throw new Error(`API fetch failed: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'API fetch failed');
                }

                currentApiFileId = result.fileId;
                displayAPIPreview(result.preview, url);
                document.getElementById('startApiComparison').disabled = false;

                document.getElementById('api-processing-section').style.display = 'none';
                document.getElementById('api-configuration-section').style.display = 'block';

            } catch (error) {
                console.error('API fetch error:', error);
                showError('API data fetch failed: ' + error.message);

                document.getElementById('api-processing-section').style.display = 'none';
                document.getElementById('api-configuration-section').style.display = 'block';
            } finally {
                fetchButton.disabled = false;
                fetchButton.innerHTML = originalText;
            }
        }

        // Display API Preview
        function displayAPIPreview(preview, apiUrl) {
            try {
                const apiFileName = document.getElementById('apiFileName');
                if (apiFileName) {
                    try {
                        apiFileName.textContent = new URL(apiUrl).hostname + ' API';
                    } catch (e) {
                        apiFileName.textContent = 'API Data';
                    }
                }

                const apiStats = document.getElementById('api-stats');
                if (apiStats) {
                    apiStats.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-number">${preview.totalRecords.toLocaleString()}</div>
                            <div class="stat-label">Total Records</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${preview.fieldsDetected}</div>
                            <div class="stat-label">Fields Detected</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${formatFileSize(preview.fileSize || 0)}</div>
                            <div class="stat-label">Data Size</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${preview.format}</div>
                            <div class="stat-label">Format</div>
                        </div>
                    `;
                }

                // Display field suggestions
                if (preview.idFields || preview.importantFields) {
                    const fieldSuggestions = document.getElementById('api-field-suggestions');
                    if (fieldSuggestions) {
                        let suggestionsHTML = '';

                        if (preview.idFields && preview.idFields.length > 0) {
                            suggestionsHTML += '<div class="field-category-header first">üîë ID/Key Fields (Recommended - Click to Use):</div>';
                            suggestionsHTML += '<div style="margin-bottom: 15px;">';
                            preview.idFields.forEach(field => {
                                suggestionsHTML += `<span class="clickable-field" onclick="setAsApiPrimaryKey('${field}')" title="Click to use ${field} as primary key">${field}</span> `;
                            });
                            suggestionsHTML += '</div>';
                        }

                        if (preview.importantFields && preview.importantFields.length > 0) {
                            suggestionsHTML += '<div class="field-category-header">üìã Other Important Fields (Click to Use):</div>';
                            suggestionsHTML += '<div>';
                            preview.importantFields.forEach(field => {
                                suggestionsHTML += `<span class="clickable-field" onclick="setAsApiPrimaryKey('${field}')" title="Click to use ${field} as primary key">${field}</span> `;
                            });
                            suggestionsHTML += '</div>';
                        }

                        fieldSuggestions.innerHTML = suggestionsHTML;
                    }
                }

                // Display API source details
                if (preview.apiSource) {
                    const sourceDetails = document.getElementById('api-source-details');
                    if (sourceDetails) {
                        sourceDetails.innerHTML = `
                            <p><strong>URL:</strong> ${preview.apiSource.url}</p>
                            <p><strong>Method:</strong> ${preview.apiSource.method}</p>
                            <p><strong>Authentication:</strong> ${preview.apiSource.authType}</p>
                            <p><strong>Records Fetched:</strong> ${preview.apiSource.recordsFetched.toLocaleString()}</p>
                            <p><strong>Fetched At:</strong> ${new Date(preview.apiSource.fetchedAt).toLocaleString()}</p>
                        `;
                    }
                }

                const apiPreview = document.getElementById('api-preview');
                if (apiPreview) {
                    apiPreview.style.display = 'block';
                }

            } catch (error) {
                console.error('Error in displayAPIPreview:', error);
                showError(`API data fetched successfully but preview display failed. You can still proceed with comparison.`);
            }
        }

        // Start API Comparison - REAL API CALL
        document.getElementById('startApiComparison').addEventListener('click', async function() {
            if (!currentApiFileId) {
                alert('Please fetch API data first!');
                return;
            }

            const primaryKey = document.getElementById('apiPrimaryKey').value.trim();
            const sourceTable = document.getElementById('apiBqTable').value.trim();

            if (!sourceTable) {
                alert('Please enter a BigQuery table name!');
                return;
            }

            if (!primaryKey) {
                alert('Please enter a primary key field name!');
                return;
            }

            const button = this;
            const originalText = button.innerHTML;

            try {
                button.disabled = true;
                button.innerHTML = 'üìä Running API vs BigQuery Analysis...';

                document.getElementById('api-configuration-section').style.display = 'none';
                document.getElementById('api-processing-section').style.display = 'block';
                document.getElementById('api-processing-text').textContent = 'Creating temporary table from API data...';
                document.getElementById('api-processing-subtext').textContent = 'Uploading API data to BigQuery for comparison';

                // Step 1: Create temp table from API data
                const tempTableResponse = await fetch('/api/create-temp-table-from-api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        fileId: currentApiFileId,
                        primaryKey: primaryKey
                    })
                });

                if (!tempTableResponse.ok) {
                    throw new Error(`Failed to create temp table from API data: ${tempTableResponse.statusText}`);
                }

                const tempTableResult = await tempTableResponse.json();

                if (!tempTableResult.success) {
                    throw new Error(tempTableResult.error || 'Failed to create temp table from API data');
                }

                document.getElementById('api-processing-text').textContent = 'Running comprehensive API vs BigQuery comparison...';
                document.getElementById('api-processing-subtext').textContent = 'Analyzing all common fields, duplicates, and data quality';

                // Step 2: Run API vs BigQuery comparison
                const comparisonResponse = await fetch('/api/compare-api-vs-bq', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        fileId: currentApiFileId,
                        sourceTable: sourceTable,
                        primaryKey: primaryKey,
                        comparisonFields: [],
                        strategy: 'enhanced'
                    })
                });

                if (!comparisonResponse.ok) {
                    throw new Error(`API comparison failed: ${comparisonResponse.statusText}`);
                }

                const compResult = await comparisonResponse.json();

                if (!compResult.success) {
                    throw new Error(compResult.error || 'API vs BigQuery comparison failed');
                }

                console.log('API vs BigQuery comparison completed successfully');
                displayAPIComparisonResults(compResult);

                document.getElementById('api-processing-section').style.display = 'none';

            } catch (error) {
                console.error('API comparison failed:', error);
                showError('API vs BigQuery comparison failed: ' + error.message);

                document.getElementById('api-processing-section').style.display = 'none';
                document.getElementById('api-configuration-section').style.display = 'block';
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        });

        // Enhanced displayAPIComparisonResults function with tabs
        function displayAPIComparisonResults(compResult) {
            // Hide configuration section
            document.getElementById('api-configuration-section').style.display = 'none';

            // Create comprehensive results display
            let resultsContainer = document.getElementById('api-results-container');
            if (!resultsContainer) {
                resultsContainer = document.createElement('div');
                resultsContainer.id = 'api-results-container';
                resultsContainer.style.padding = '30px';
                resultsContainer.style.background = 'white';

                const processingSection = document.getElementById('api-processing-section');
                processingSection.parentNode.insertBefore(resultsContainer, processingSection.nextSibling);
            }

            // Build comprehensive results HTML with tabs
            resultsContainer.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2 style="color: #2c3e50; margin: 0; display: flex; align-items: center; gap: 12px;">
                        <span>üìä</span> API vs BigQuery Analysis Results
                    </h2>
                    <div>
                        <button class="btn-primary" onclick="exportAPIResults()" style="margin-right: 10px; background: #27ae60;">
                            üìä Export to Excel
                        </button>
                        <button class="btn-secondary" onclick="newAPIComparison()">
                            New Comparison
                        </button>
                    </div>
                </div>

                <!-- Tabs Navigation -->
                <div style="border-bottom: 2px solid #e9ecef; margin-bottom: 30px;">
                    <div style="display: flex; gap: 0;">
                        <button class="api-result-tab active" onclick="showAPIResultsTab('record-count')"
                            style="padding: 12px 24px; border: none; background: white; border-bottom: 3px solid #3498db; color: #2c3e50; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            üìä Record Count
                        </button>
                        <button class="api-result-tab" onclick="showAPIResultsTab('column-names')"
                            style="padding: 12px 24px; border: none; background: #f8f9fa; border-bottom: 3px solid transparent; color: #6c757d; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            üìã Column Names
                        </button>
                        <button class="api-result-tab" onclick="showAPIResultsTab('comparison')"
                            style="padding: 12px 24px; border: none; background: #f8f9fa; border-bottom: 3px solid transparent; color: #6c757d; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            üîç Comparison
                        </button>
                        <button class="api-result-tab" onclick="showAPIResultsTab('field-analysis')"
                            style="padding: 12px 24px; border: none; background: #f8f9fa; border-bottom: 3px solid transparent; color: #6c757d; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            üìà Field Analysis
                        </button>
                        <button class="api-result-tab" onclick="showAPIResultsTab('duplicates')"
                            style="padding: 12px 24px; border: none; background: #f8f9fa; border-bottom: 3px solid transparent; color: #6c757d; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            üîÑ Duplicates
                        </button>
                    </div>
                </div>

                <!-- Tab Content Container -->
                <div id="api-tab-content-container">
                    <!-- Content will be dynamically inserted here -->
                </div>
            `;

            resultsContainer.style.display = 'block';

            // Store the results globally for tab switching
            window.currentAPIComparisonResults = compResult;

            // Show initial tab
            showAPIResultsTab('record-count');
        }

        // API-specific tab switching functionality
        function showAPIResultsTab(tabName) {
            // Update API tab buttons
            document.querySelectorAll('.api-result-tab').forEach(tab => {
                tab.style.background = '#f8f9fa';
                tab.style.borderBottomColor = 'transparent';
                tab.style.color = '#6c757d';
                tab.classList.remove('active');
            });

            // Activate selected tab
            if (event && event.target) {
                event.target.style.background = 'white';
                event.target.style.borderBottomColor = '#3498db';
                event.target.style.color = '#2c3e50';
                event.target.classList.add('active');
            }

            // Get API results data
            const results = window.currentAPIComparisonResults || {};

            // Generate content based on tab
            let content = '';

            switch(tabName) {
                case 'record-count':
                    content = generateAPIRecordCountTab(results);
                    break;
                case 'column-names':
                    content = generateAPIColumnNamesTab(results);
                    break;
                case 'comparison':
                    content = generateAPIComparisonTab(results);
                    break;
                case 'field-analysis':
                    content = generateAPIFieldAnalysisTab(results);
                    break;
                case 'duplicates':
                    content = generateAPIDuplicatesTab(results);
                    break;
            }

            document.getElementById('api-tab-content-container').innerHTML = content;
        }

        // API-specific tab content generator functions
        function generateAPIRecordCountTab(results) {
            const summary = results.summary || {};
            const recordCounts = results.recordCounts || {};
            const apiDetails = recordCounts.apiDetails || recordCounts.jsonDetails || {};
            const bqDetails = recordCounts.bqDetails || {};

            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="metric-card pass">
                        <div class="metric-number pass">${apiDetails.totalRecords || summary.totalRecordsInFile || 0}</div>
                        <div class="metric-label">API TOTAL RECORDS</div>
                    </div>
                    <div class="metric-card pass">
                        <div class="metric-number pass">${bqDetails.totalRecords || summary.targetRecords || 0}</div>
                        <div class="metric-label">BIGQUERY TOTAL RECORDS</div>
                    </div>
                    <div class="metric-card pass">
                        <div class="metric-number pass">${apiDetails.uniquePrimaryKeys || summary.uniqueSourceRecords || 0}</div>
                        <div class="metric-label">API UNIQUE KEYS</div>
                    </div>
                    <div class="metric-card pass">
                        <div class="metric-number pass">${bqDetails.uniquePrimaryKeys || summary.targetRecords || 0}</div>
                        <div class="metric-label">BIGQUERY UNIQUE KEYS</div>
                    </div>
                    <div class="metric-card ${(apiDetails.duplicateRecords || 0) > 0 ? 'warning' : 'pass'}">
                        <div class="metric-number ${(apiDetails.duplicateRecords || 0) > 0 ? 'warning' : 'pass'}">${apiDetails.duplicateRecords || 0}</div>
                        <div class="metric-label">API DUPLICATES</div>
                    </div>
                    <div class="metric-card pass">
                        <div class="metric-number pass">${apiDetails.nullPrimaryKeys || 0}</div>
                        <div class="metric-label">TOTAL NULL KEYS</div>
                    </div>
                </div>

                <!-- Detailed Record Analysis Table -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 30px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px 12px 0 0; border-bottom: 2px solid #e9ecef;">
                        <h3 style="color: #2c3e50; margin: 0; display: flex; align-items: center; gap: 10px;">
                            üìä Detailed Record Analysis
                        </h3>
                        <p style="color: #6c757d; margin: 8px 0 0 0; font-size: 0.95rem;">
                            Primary Key Used: <strong>${summary.primaryKeyUsed || 'N/A'}</strong> (supports any custom field)
                        </p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0;">
                        <!-- API Source Analysis -->
                        <div style="padding: 25px; border-right: 1px solid #e9ecef;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                üîó API Source Analysis
                            </h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Total Records:</td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: #2c3e50;">${summary.totalRecordsInFile || apiDetails.totalRecords || 0}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Unique Primary Keys:</td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: #2c3e50;">${summary.uniqueSourceRecords || apiDetails.uniquePrimaryKeys || 0}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Duplicate Records:</td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: ${(apiDetails.duplicateRecords || 0) > 0 ? '#f39c12' : '#27ae60'};">${apiDetails.duplicateRecords || 0} ${(apiDetails.duplicateRecords || 0) > 0 ? '‚ö†Ô∏è' : '‚úÖ'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; font-weight: 600; color: #495057;">Primary Key Field:</td>
                                    <td style="padding: 8px 0; text-align: right; color: #2c3e50;">${summary.primaryKeyUsed || 'N/A'}</td>
                                </tr>
                            </table>
                        </div>

                        <!-- BigQuery Target Analysis -->
                        <div style="padding: 25px;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                üóÑÔ∏è BigQuery Target Analysis
                            </h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Total Records:</td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: #2c3e50;">${summary.targetRecords || bqDetails.totalRecords || 0}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Unique Primary Keys:</td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: #2c3e50;">${bqDetails.uniquePrimaryKeys || summary.targetRecords || 0}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Primary Key Nulls:</td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: #27ae60;">${bqDetails.nullPrimaryKeys || 0} ‚úÖ</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; font-weight: 600; color: #495057;">Primary Key Field:</td>
                                    <td style="padding: 8px 0; text-align: right; color: #2c3e50;">${summary.primaryKeyUsed || 'N/A'}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateAPIColumnNamesTab(results) {
            const schemaAnalysis = results.schemaAnalysis || {};
            const commonFields = schemaAnalysis.commonFields || [];
            const apiOnlyFields = schemaAnalysis.jsonOnlyFields || schemaAnalysis.apiOnlyFields || [];
            const bqOnlyFields = schemaAnalysis.bqOnlyFields || [];

            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="metric-card pass">
                        <div class="metric-number pass">${schemaAnalysis.totalJsonFields || schemaAnalysis.totalApiFields || 0}</div>
                        <div class="metric-label">API FIELDS</div>
                    </div>
                    <div class="metric-card pass">
                        <div class="metric-number pass">${schemaAnalysis.totalBqFields || 0}</div>
                        <div class="metric-label">BIGQUERY FIELDS</div>
                    </div>
                    <div class="metric-card pass">
                        <div class="metric-number pass">${commonFields.length}</div>
                        <div class="metric-label">COMMON FIELDS</div>
                    </div>
                    <div class="metric-card ${apiOnlyFields.length > 0 ? 'warning' : 'pass'}">
                        <div class="metric-number ${apiOnlyFields.length > 0 ? 'warning' : 'pass'}">${apiOnlyFields.length}</div>
                        <div class="metric-label">API ONLY</div>
                    </div>
                    <div class="metric-card ${bqOnlyFields.length > 0 ? 'warning' : 'pass'}">
                        <div class="metric-number ${bqOnlyFields.length > 0 ? 'warning' : 'pass'}">${bqOnlyFields.length}</div>
                        <div class="metric-label">BIGQUERY ONLY</div>
                    </div>
                </div>

                <!-- Schema Compatibility Analysis -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 30px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px 12px 0 0; border-bottom: 2px solid #e9ecef;">
                        <h3 style="color: #2c3e50; margin: 0; display: flex; align-items: center; gap: 10px;">
                            üìã Schema Compatibility Analysis
                        </h3>
                        <p style="color: #6c757d; margin: 8px 0 0 0; font-size: 0.95rem;">
                            Detailed analysis of field differences between API source and BigQuery target
                        </p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0;">
                        <!-- Common Fields -->
                        <div style="padding: 25px; border-right: 1px solid #e9ecef;">
                            <h4 style="color: #27ae60; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                ‚úÖ Common Fields
                            </h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${commonFields.map(field => `
                                    <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f3f4;">
                                        <span style="width: 20px; height: 20px; background: #d4edda; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 12px;">üìã</span>
                                        <span style="color: #2c3e50; font-family: monospace; font-size: 14px;">${field}</span>
                                    </div>
                                `).join('')}
                                ${commonFields.length === 0 ? '<div style="color: #6c757d; font-style: italic;">No common fields found</div>' : ''}
                            </div>
                        </div>

                        <!-- API-Only Fields -->
                        <div style="padding: 25px; border-right: 1px solid #e9ecef;">
                            <h4 style="color: #dc3545; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                üîó API-Only Fields
                            </h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${apiOnlyFields.map(field => `
                                    <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f3f4;">
                                        <span style="width: 20px; height: 20px; background: #f8d7da; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 12px;">üîó</span>
                                        <span style="color: #721c24; font-family: monospace; font-size: 14px;">${field}</span>
                                    </div>
                                `).join('')}
                                ${apiOnlyFields.length === 0 ? '<div style="color: #6c757d; font-style: italic;">No API-only fields</div>' : ''}
                            </div>
                            ${apiOnlyFields.length > 0 ? '<div style="margin-top: 10px; padding: 8px; background: #f8d7da; border-radius: 4px; font-size: 12px; color: #721c24;"><strong>‚ö†Ô∏è Note:</strong> These fields exist in API but not in BigQuery</div>' : ''}
                        </div>

                        <!-- BigQuery-Only Fields -->
                        <div style="padding: 25px;">
                            <h4 style="color: #fd7e14; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                üóÑÔ∏è BigQuery-Only Fields
                            </h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${bqOnlyFields.map(field => `
                                    <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f3f4;">
                                        <span style="width: 20px; height: 20px; background: #fff3cd; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 12px;">üóÑÔ∏è</span>
                                        <span style="color: #856404; font-family: monospace; font-size: 14px;">${field}</span>
                                    </div>
                                `).join('')}
                                ${bqOnlyFields.length === 0 ? '<div style="color: #6c757d; font-style: italic;">No BigQuery-only fields</div>' : ''}
                            </div>
                            ${bqOnlyFields.length > 0 ? '<div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 4px; font-size: 12px; color: #856404;"><strong>‚ÑπÔ∏è Note:</strong> Auto-generated or system fields in BigQuery</div>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateAPIComparisonTab(results) {
            const summary = results.summary || {};

            return `
                <div style="background: #d1ecf1; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                    <h3 style="margin: 0 0 10px 0; display: flex; align-items: center; gap: 8px;">üîç Field-Based Comparison</h3>
                    <p style="margin: 0; font-size: 16px;">Analyzing data transfer from API Source (${summary.totalRecordsInFile || 0} records) ‚Üí BigQuery Target (${summary.targetRecords || 0} records) using primary key: <strong>${summary.primaryKeyUsed || 'N/A'}</strong></p>
                    <div style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.7); border-radius: 6px;">
                        <p style="margin: 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            üîë <strong>Using primary key:</strong> ${summary.primaryKeyUsed || 'N/A'} (validated to exist in both tables)
                        </p>
                        <p style="margin: 8px 0 0 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            üìä <strong>Schema compatibility:</strong> ${summary.schemaCompatibility || '0.0%'} (${summary.commonFields || 0} common fields)
                        </p>
                        <p style="margin: 8px 0 0 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            ‚úÖ <strong>Pipeline success rate:</strong> ${summary.pipelineSuccessRate || '0.0'}% (${summary.recordsReachedTarget || 0}/${summary.uniqueSourceRecords || 0} unique records found in target)
                        </p>
                        <p style="margin: 8px 0 0 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            üîç <strong>Field analysis:</strong> ${summary.fieldsAnalyzed || 0} common fields analyzed across ${summary.recordsReachedTarget || 0} matched records
                        </p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="metric-card pass">
                        <div class="metric-number pass">${summary.uniqueSourceRecords || 0}</div>
                        <div class="metric-label">UNIQUE SOURCE RECORDS</div>
                    </div>
                    <div class="metric-card pass">
                        <div class="metric-number pass">${summary.recordsReachedTarget || 0}</div>
                        <div class="metric-label">FOUND IN TARGET</div>
                    </div>
                    <div class="metric-card ${(summary.recordsFailedToReachTarget || 0) > 0 ? 'warning' : 'pass'}">
                        <div class="metric-number ${(summary.recordsFailedToReachTarget || 0) > 0 ? 'warning' : 'pass'}">${summary.recordsFailedToReachTarget || 0}</div>
                        <div class="metric-label">NOT IN TARGET</div>
                    </div>
                    <div class="metric-card ${(summary.totalFieldIssues || 0) > 0 ? 'warning' : 'pass'}">
                        <div class="metric-number ${(summary.totalFieldIssues || 0) > 0 ? 'warning' : 'pass'}">${summary.totalFieldIssues || 0}</div>
                        <div class="metric-label">FIELD QUALITY ISSUES</div>
                    </div>
                    <div class="metric-card ${parseFloat(summary.pipelineSuccessRate || '0') >= 95 ? 'pass' : parseFloat(summary.pipelineSuccessRate || '0') >= 80 ? 'warning' : 'fail'}">
                        <div class="metric-number ${parseFloat(summary.pipelineSuccessRate || '0') >= 95 ? 'pass' : parseFloat(summary.pipelineSuccessRate || '0') >= 80 ? 'warning' : 'fail'}">${summary.pipelineSuccessRate || '0.0'}%</div>
                        <div class="metric-label">PIPELINE SUCCESS RATE</div>
                    </div>
                </div>
            `;
        }

        function generateAPIFieldAnalysisTab(results) {
            const fieldAnalysis = results.fieldWiseAnalysis || {};
            const fieldDetails = fieldAnalysis.fieldComparison || [];

            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="metric-card pass">
                        <div class="metric-number pass">${fieldAnalysis.fieldsAnalyzed || 0}</div>
                        <div class="metric-label">FIELDS ANALYZED</div>
                    </div>
                    <div class="metric-card pass">
                        <div class="metric-number pass">${fieldAnalysis.perfectFields || 0}</div>
                        <div class="metric-label">PERFECT FIELDS</div>
                    </div>
                    <div class="metric-card ${(fieldAnalysis.problematicFields || 0) > 0 ? 'warning' : 'pass'}">
                        <div class="metric-number ${(fieldAnalysis.problematicFields || 0) > 0 ? 'warning' : 'pass'}">${fieldAnalysis.problematicFields || 0}</div>
                        <div class="metric-label">FIELDS WITH ISSUES</div>
                    </div>
                    <div class="metric-card ${(fieldAnalysis.totalFieldIssues || 0) > 0 ? 'warning' : 'pass'}">
                        <div class="metric-number ${(fieldAnalysis.totalFieldIssues || 0) > 0 ? 'warning' : 'pass'}">${fieldAnalysis.totalFieldIssues || 0}</div>
                        <div class="metric-label">TOTAL QUALITY ISSUES</div>
                    </div>
                    <div class="metric-card pass">
                        <div class="metric-number pass">${fieldAnalysis.recordsAnalyzed || 0}</div>
                        <div class="metric-label">RECORDS ANALYZED</div>
                    </div>
                </div>

                <!-- Field Analysis Results -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 30px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px 12px 0 0; border-bottom: 2px solid #e9ecef;">
                        <h3 style="color: #2c3e50; margin: 0; display: flex; align-items: center; gap: 10px;">
                            üî¨ Field Quality Analysis Results
                        </h3>
                        <p style="color: #6c757d; margin: 8px 0 0 0; font-size: 0.95rem;">
                            ${fieldAnalysis.summary || 'Field comparison analysis completed'}
                        </p>
                    </div>

                    <div style="padding: 25px;">
                        ${fieldDetails.length > 0 ? `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; color: #495057;">Field Name</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6; color: #495057;">Records</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6; color: #495057;">Matches</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6; color: #495057;">Differences</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6; color: #495057;">Match Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${fieldDetails.map((field, index) => `
                                    <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                                        <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-family: monospace; font-weight: 600; color: #2c3e50;">${field.fieldName || 'Unknown'}</td>
                                        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${field.totalRecords || 0}</td>
                                        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; color: ${(field.perfectMatches || 0) > 0 ? '#27ae60' : '#dc3545'}; font-weight: 600;">${field.perfectMatches || 0}</td>
                                        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; color: ${(field.differences || 0) === 0 ? '#27ae60' : '#dc3545'}; font-weight: 600;">${field.differences || 0}</td>
                                        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; color: ${parseFloat(field.matchRate || '0') >= 95 ? '#27ae60' : parseFloat(field.matchRate || '0') >= 80 ? '#f39c12' : '#dc3545'}; font-weight: 600;">${field.matchRate || '0.0'}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ` : '<div style="text-align: center; color: #6c757d; padding: 40px;">No field analysis data available</div>'}
                    </div>
                </div>
            `;
        }

        function generateAPIDuplicatesTab(results) {
            const duplicates = results.duplicatesAnalysis || {};
            const apiDuplicates = duplicates.apiDuplicates || duplicates.jsonDuplicates || {};
            const bqDuplicates = duplicates.bqDuplicates || {};
            const recommendations = duplicates.recommendations || [];

            return `
                <!-- Comprehensive Duplicate Records Analysis -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 30px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px 12px 0 0; border-bottom: 2px solid #e9ecef;">
                        <h3 style="color: #2c3e50; margin: 0; display: flex; align-items: center; gap: 10px;">
                            üìã Comprehensive Duplicate Records Analysis
                        </h3>
                        <p style="color: #6c757d; margin: 8px 0 0 0; font-size: 0.95rem;">
                            Detailed analysis of duplicate records across both source and target systems
                        </p>
                    </div>

                    <div style="padding: 25px;">
                        <!-- Dual-System Duplicates Analysis -->
                        <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                            <h4 style="color: #1976d2; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                üîç Dual-System Duplicates Analysis
                            </h4>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <!-- API Source System -->
                                <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid ${(apiDuplicates.duplicateCount || 0) > 0 ? '#f39c12' : '#27ae60'};">
                                    <h5 style="color: ${(apiDuplicates.duplicateCount || 0) > 0 ? '#f39c12' : '#27ae60'}; margin: 0 0 15px 0; display: flex; align-items: center; gap: 6px;">
                                        üîó API Source System
                                    </h5>

                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tbody>
                                            <tr>
                                                <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Duplicate Keys:</td>
                                                <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: ${(apiDuplicates.duplicateCount || 0) > 0 ? '#f39c12' : '#27ae60'}; font-weight: 600;">${apiDuplicates.duplicateCount || 0}</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Total Duplicate Records:</td>
                                                <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: ${(apiDuplicates.totalDuplicateRecords || 0) > 0 ? '#f39c12' : '#27ae60'}; font-weight: 600;">${apiDuplicates.totalDuplicateRecords || 0}</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 8px 0; font-weight: 600; color: #495057;">Status:</td>
                                                <td style="padding: 8px 0; text-align: right;">
                                                    <span style="background: ${(apiDuplicates.duplicateCount || 0) > 0 ? '#fff3cd' : '#d4edda'}; color: ${(apiDuplicates.duplicateCount || 0) > 0 ? '#856404' : '#155724'}; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                                        ${(apiDuplicates.duplicateCount || 0) > 0 ? '‚ö†Ô∏è Has Duplicates' : '‚úÖ Clean'}
                                                    </span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- BigQuery Target System -->
                                <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid ${(bqDuplicates.duplicateCount || 0) > 0 ? '#f39c12' : '#27ae60'};">
                                    <h5 style="color: ${(bqDuplicates.duplicateCount || 0) > 0 ? '#f39c12' : '#27ae60'}; margin: 0 0 15px 0; display: flex; align-items: center; gap: 6px;">
                                        üóÑÔ∏è BigQuery Target System
                                    </h5>

                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tbody>
                                            <tr>
                                                <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Duplicate Keys:</td>
                                                <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: ${(bqDuplicates.duplicateCount || 0) > 0 ? '#f39c12' : '#27ae60'}; font-weight: 600;">${bqDuplicates.duplicateCount || 0}</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; font-weight: 600; color: #495057;">Total Duplicate Records:</td>
                                                <td style="padding: 8px 0; border-bottom: 1px solid #f1f3f4; text-align: right; color: ${(bqDuplicates.totalDuplicateRecords || 0) > 0 ? '#f39c12' : '#27ae60'}; font-weight: 600;">${bqDuplicates.totalDuplicateRecords || 0}</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 8px 0; font-weight: 600; color: #495057;">Status:</td>
                                                <td style="padding: 8px 0; text-align: right;">
                                                    <span style="background: ${(bqDuplicates.duplicateCount || 0) > 0 ? '#fff3cd' : '#d4edda'}; color: ${(bqDuplicates.duplicateCount || 0) > 0 ? '#856404' : '#155724'}; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                                        ${(bqDuplicates.duplicateCount || 0) > 0 ? '‚ö†Ô∏è Has Duplicates' : '‚úÖ Clean'}
                                                    </span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Recommendations -->
                        ${recommendations.length > 0 ? `
                        <div style="background: #d4edda; padding: 20px; border-radius: 8px; border-left: 4px solid #27ae60;">
                            <h4 style="color: #155724; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                üí° Recommendations
                            </h4>

                            <ul style="margin: 0; padding-left: 20px; color: #155724;">
                                ${recommendations.map(rec => `<li style="margin-bottom: 8px; line-height: 1.6;">${rec}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function exportAPIResults() {
            alert('Excel export functionality for API results will be available soon!');
        }

        function newAPIComparison() {
            const resultsContainer = document.getElementById('api-results-container');
            if (resultsContainer) {
                resultsContainer.style.display = 'none';
            }

            document.getElementById('api-configuration-section').style.display = 'block';
            currentApiFileId = null;
            document.getElementById('startApiComparison').disabled = true;
            document.getElementById('api-preview').style.display = 'none';

            // Reset form fields
            document.getElementById('apiUrl').value = '';
            document.getElementById('apiMethod').selectedIndex = 0;
            document.getElementById('authType').selectedIndex = 0;
            document.getElementById('apiHeaders').value = '';
            document.getElementById('apiBody').value = '';
            document.getElementById('dataPath').value = '';
            document.getElementById('maxRecords').value = '100';
            document.getElementById('apiBqTable').value = '';
            document.getElementById('apiPrimaryKey').value = '';

            updateAuthFields(); // Reset auth fields
        }

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ETL Data Validation Dashboard initialized successfully');

            // Initialize auth fields
            updateAuthFields();

            // Set up form validation
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    const requiredFields = form.querySelectorAll('[required]');
                    let isValid = true;

                    requiredFields.forEach(field => {
                        if (!field.value.trim()) {
                            isValid = false;
                            field.style.borderColor = '#e74c3c';
                        } else {
                            field.style.borderColor = '#e9ecef';
                        }
                    });

                    if (!isValid) {
                        e.preventDefault();
                        alert('Please fill in all required fields');
                    }
                });
            });

            // Clear any existing error messages on input
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    this.style.borderColor = '#e9ecef';
                });
            });
        });
    </script>
</body>
</html>